# æ•°æ®æ¸…ç†ä½¿ç”¨æŒ‡å—

## ğŸ“‹ å¿«é€Ÿå¼€å§‹

### 1. æ£€æŸ¥å½“å‰æ•°æ®é‡

```bash
cd /home/spider/31339752/backend/scripts
python3 check_database_size.py
```

è¿™ä¼šæ˜¾ç¤ºï¼š
- æ•°æ®åº“æ€»ä½“å¤§å°
- å„åƒµå°¸ç½‘ç»œç±»å‹çš„æ•°æ®é‡
- å¯æ¸…ç†çš„æ—§æ•°æ®é‡
- æ•°æ®å¢é•¿è¶‹åŠ¿

### 2. è¯•è¿è¡Œæ¸…ç†ï¼ˆå®‰å…¨æµ‹è¯•ï¼‰

```bash
# æŸ¥çœ‹ä¼šåˆ é™¤å“ªäº›æ•°æ®ï¼Œä½†ä¸å®é™…åˆ é™¤
python3 cleanup_old_data.py --dry-run
```

### 3. æ­£å¼æ¸…ç†æ•°æ®

```bash
# æ¸…ç†180å¤©å‰çš„æ•°æ®ï¼ˆé»˜è®¤ï¼‰
python3 cleanup_old_data.py

# æ¸…ç†90å¤©å‰çš„æ•°æ®
python3 cleanup_old_data.py --days 90

# åªæ¸…ç†ç‰¹å®šåƒµå°¸ç½‘ç»œ
python3 cleanup_old_data.py --botnet asruex
```

---

## â° è®¾ç½®è‡ªåŠ¨æ¸…ç†

### æ–¹æ³•1ï¼šä½¿ç”¨crontabï¼ˆæ¨èï¼‰

```bash
# ç¼–è¾‘crontab
crontab -e

# æ·»åŠ ä»¥ä¸‹è¡Œï¼ˆæ¯å¤©å‡Œæ™¨2ç‚¹æ‰§è¡Œï¼‰
0 2 * * * /home/spider/31339752/backend/scripts/cleanup_old_data.sh
```

### æ–¹æ³•2ï¼šæ‰‹åŠ¨æ‰§è¡Œshellè„šæœ¬

```bash
# ç›´æ¥è¿è¡Œï¼ˆä¼šè®°å½•æ—¥å¿—ï¼‰
/home/spider/31339752/backend/scripts/cleanup_old_data.sh
```

### æŸ¥çœ‹æ¸…ç†æ—¥å¿—

```bash
tail -f /home/spider/31339752/backend/logs/data_cleanup.log
```

---

## ğŸ” å¸¸è§åœºæ™¯

### åœºæ™¯1ï¼šå­˜å‚¨ç©ºé—´ç´§å¼ 

```bash
# ç«‹å³æ¸…ç†90å¤©å‰çš„æ•°æ®
python3 cleanup_old_data.py --days 90

# æ£€æŸ¥é‡Šæ”¾çš„ç©ºé—´
python3 check_database_size.py
```

### åœºæ™¯2ï¼šæŸ¥çœ‹æ•°æ®å¢é•¿æƒ…å†µ

```bash
# æŸ¥çœ‹æœ€è¿‘7å¤©çš„æ•°æ®å¢é•¿
python3 check_database_size.py

# æŸ¥çœ‹30å¤©å‰å¯æ¸…ç†çš„æ•°æ®é‡
python3 check_database_size.py --retention-days 30
```

### åœºæ™¯3ï¼šä¿ç•™æ›´é•¿æ—¶é—´çš„æ•°æ®

```bash
# ä¿ç•™1å¹´æ•°æ®
python3 cleanup_old_data.py --days 365
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### æ¸…ç†å‰
1. âœ… å…ˆè¿è¡Œ `--dry-run` æŸ¥çœ‹å½±å“
2. âœ… ç¡®è®¤å¤‡ä»½ç­–ç•¥
3. âœ… åœ¨ä½å³°æœŸæ‰§è¡Œ

### æ¸…ç†ä¸­
- åˆ†æ‰¹åˆ é™¤ï¼Œä¸ä¼šé”è¡¨å¤ªä¹…
- å¯ä»¥éšæ—¶Ctrl+Cä¸­æ–­
- æ”¯æŒæ–­ç‚¹ç»­ä¼ 

### æ¸…ç†å
- è‡ªåŠ¨ä¼˜åŒ–è¡¨ï¼Œé‡Šæ”¾ç©ºé—´
- æ£€æŸ¥æ—¥å¿—ç¡®è®¤æ‰§è¡Œç»“æœ
- éªŒè¯æ•°æ®å®Œæ•´æ€§

---

## ğŸ“Š ç›‘æ§æŒ‡æ ‡

å®šæœŸæ£€æŸ¥ä»¥ä¸‹æŒ‡æ ‡ï¼š

```bash
# 1. æ•°æ®åº“å¤§å°
python3 check_database_size.py

# 2. ç£ç›˜ç©ºé—´
df -h

# 3. æ•°æ®å¢é•¿è¶‹åŠ¿
# æŸ¥çœ‹check_database_size.pyè¾“å‡ºçš„å¢é•¿è¶‹åŠ¿éƒ¨åˆ†
```

---

## ğŸ› ï¸ é«˜çº§ç”¨æ³•

### è‡ªå®šä¹‰æ¸…ç†è§„åˆ™

ç¼–è¾‘ `cleanup_old_data.py`ï¼Œä¿®æ”¹ä»¥ä¸‹å‚æ•°ï¼š

```python
RETENTION_DAYS = 180  # ä¿ç•™å¤©æ•°
BATCH_SIZE = 10000    # æ¯æ‰¹åˆ é™¤æ•°é‡
```

### åªæ¸…ç†ç‰¹å®šç±»å‹

```bash
# åªæ¸…ç†asruexçš„æ•°æ®
python3 cleanup_old_data.py --botnet asruex --days 90

# æ¸…ç†å¤šä¸ªç±»å‹ï¼ˆéœ€è¦å¤šæ¬¡è¿è¡Œï¼‰
python3 cleanup_old_data.py --botnet asruex --days 90
python3 cleanup_old_data.py --botnet mozi --days 90
```

---

## ğŸ“ æ•…éšœæ’é™¤

### é—®é¢˜1ï¼šæ¸…ç†é€Ÿåº¦æ…¢
- åŸå› ï¼šæ•°æ®é‡å¤§
- è§£å†³ï¼šå¢åŠ  `BATCH_SIZE`ï¼Œå¦‚æ”¹ä¸º50000

### é—®é¢˜2ï¼šæç¤ºè¡¨ä¸å­˜åœ¨
- åŸå› ï¼šè¯¥åƒµå°¸ç½‘ç»œç±»å‹æ²¡æœ‰æ•°æ®
- è§£å†³ï¼šæ­£å¸¸ç°è±¡ï¼Œä¼šè‡ªåŠ¨è·³è¿‡

### é—®é¢˜3ï¼šæ¸…ç†åç©ºé—´æœªé‡Šæ”¾
- åŸå› ï¼šMySQLæœªå›æ”¶ç©ºé—´
- è§£å†³ï¼šè¿è¡Œ `OPTIMIZE TABLE` æˆ–é‡å¯MySQL

```bash
# æ‰‹åŠ¨ä¼˜åŒ–è¡¨
mysql -uroot -p -e "OPTIMIZE TABLE botnet.botnet_communications_asruex"
```

---

## ğŸ“ Crontabé…ç½®ç¤ºä¾‹

```bash
# æ¯å¤©å‡Œæ™¨2ç‚¹æ¸…ç†180å¤©å‰çš„æ•°æ®
0 2 * * * /home/spider/31339752/backend/scripts/cleanup_old_data.sh

# æ¯å‘¨æ—¥å‡Œæ™¨3ç‚¹æ£€æŸ¥æ•°æ®åº“å¤§å°å¹¶å‘é€é‚®ä»¶
0 3 * * 0 /home/spider/31339752/backend/scripts/check_database_size.py | mail -s "æ•°æ®åº“å‘¨æŠ¥" admin@example.com

# æ¯æœˆ1å·å‡Œæ™¨4ç‚¹ä¼˜åŒ–æ‰€æœ‰è¡¨
0 4 1 * * mysql -uroot -pMatrix123 -e "SELECT CONCAT('OPTIMIZE TABLE ', table_schema, '.', table_name, ';') FROM information_schema.tables WHERE table_schema='botnet'" | grep OPTIMIZE | mysql -uroot -pMatrix123
```

---

## âœ… éªŒè¯æ¸…ç†ç»“æœ

### 1. æŸ¥çœ‹åˆ é™¤çš„è®°å½•æ•°
æ£€æŸ¥æ—¥å¿—è¾“å‡ºï¼š
```
[asruex] æ¸…ç†å®Œæˆï¼Œå…±åˆ é™¤ 1234567 æ¡è®°å½•
```

### 2. éªŒè¯æ•°æ®å®Œæ•´æ€§
```bash
# æ£€æŸ¥æœ€æ–°æ•°æ®æ˜¯å¦å­˜åœ¨
mysql -uroot -pMatrix123 -e "
SELECT botnet_type, COUNT(*) as count, MAX(communication_time) as latest 
FROM (
    SELECT 'asruex' as botnet_type, communication_time FROM botnet.botnet_communications_asruex
    UNION ALL
    SELECT 'mozi', communication_time FROM botnet.botnet_communications_mozi
) t
GROUP BY botnet_type
"
```

### 3. ç¡®è®¤ä¿ç•™æœŸæ­£ç¡®
```bash
# æ£€æŸ¥æœ€æ—©çš„æ•°æ®æ—¶é—´
mysql -uroot -pMatrix123 -e "
SELECT MIN(communication_time) as oldest, MAX(communication_time) as newest, 
       DATEDIFF(MAX(communication_time), MIN(communication_time)) as days
FROM botnet.botnet_communications_asruex
"
```

---

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–å»ºè®®

### å¤§æ•°æ®é‡ä¼˜åŒ–
å¦‚æœå•è¡¨è¶…è¿‡1äº¿æ¡è®°å½•ï¼Œå»ºè®®ï¼š

1. **ä½¿ç”¨åˆ†åŒºè¡¨**
```sql
ALTER TABLE botnet_communications_asruex
PARTITION BY RANGE (TO_DAYS(communication_time)) (
    PARTITION p202501 VALUES LESS THAN (TO_DAYS('2025-02-01')),
    PARTITION p202502 VALUES LESS THAN (TO_DAYS('2025-03-01')),
    ...
);
```

2. **åˆ é™¤æ•´ä¸ªåˆ†åŒº**ï¼ˆè¶…å¿«ï¼‰
```sql
ALTER TABLE botnet_communications_asruex DROP PARTITION p202501;
```

---

**æœ€åæ›´æ–°**: 2025-01-21
