# 数据保留期建议 - 执行摘要

## 🎯 核心建议

**推荐保留期：180天（6个月）**

---

## 📊 关键数据

### 服务器配置
- CPU: 24核
- 内存: 62GB  
- 磁盘: 3.6TB（可用3.0TB）

### 数据规模
- 每日新增：100万条（10个C2 × 10万条/天）
- 每日存储：约550MB
- 180天存储：约90GB（仅占磁盘3%）

---

## ✅ 为什么选择180天？

| 维度 | 说明 |
|-----|------|
| **存储安全** | 仅占3%磁盘空间，远低于警戒线 |
| **业务价值** | 满足半年期趋势分析、季节性研究 |
| **查询性能** | 1.8亿条记录，查询速度良好 |
| **运维成本** | 适中的清理频率，易于维护 |

---

## 🚀 快速开始

### 1️⃣ 检查当前状态
```bash
cd /home/spider/31339752/backend/scripts
python3 check_database_size.py
```

### 2️⃣ 测试清理（不实际删除）
```bash
python3 cleanup_old_data.py --dry-run
```

### 3️⃣ 执行清理
```bash
# 保留180天数据
python3 cleanup_old_data.py

# 或保留其他天数
python3 cleanup_old_data.py --days 90
```

### 4️⃣ 设置自动清理
```bash
# 编辑crontab
crontab -e

# 添加定时任务（每天凌晨2点）
0 2 * * * /home/spider/31339752/backend/scripts/cleanup_old_data.sh
```

---

## 📁 文档清单

已创建以下文档供参考：

1. **数据保留期建议.md** - 完整分析报告
2. **数据清理使用指南.md** - 操作手册
3. **cleanup_old_data.py** - 清理脚本
4. **check_database_size.py** - 检查脚本
5. **cleanup_old_data.sh** - 定时任务脚本

---

## 📈 其他保留期方案

根据实际需求，也可选择：

| 保留期 | 存储占用 | 适用场景 |
|--------|---------|---------|
| 90天 | ~45GB (1.5%) | 实时监控为主，存储敏感 |
| **180天** ⭐ | ~90GB (3%) | **推荐：平衡存储与分析** |
| 365天 | ~180GB (6%) | 长期研究、年度对比分析 |

---

## ⚠️ 重要提示

### 清理的是什么？
- ✅ 清理：`botnet_communications_{type}` 表（通信记录）
- ❌ 不清理：`botnet_nodes_{type}` 表（节点汇总，保留所有历史）
- ❌ 不清理：统计表（数据量小，无需清理）

### 清理前务必
1. 先运行 `--dry-run` 查看影响
2. 确认备份策略
3. 在业务低峰期执行
4. 查看执行日志确认结果

---

## 📞 技术支持

### 查看日志
```bash
# 清理日志
tail -f /home/spider/31339752/backend/logs/data_cleanup.log

# 数据库日志
tail -f /var/log/mysql/error.log
```

### 常见问题

**Q: 清理后空间没释放？**
A: 运行 `OPTIMIZE TABLE` 或重启MySQL

**Q: 清理速度太慢？**
A: 增加脚本中的 `BATCH_SIZE` 参数

**Q: 能恢复已删除的数据吗？**
A: 无法恢复，请务必先做好备份或使用 `--dry-run` 测试

---

## 📊 监控建议

定期检查（建议每周）：

```bash
# 检查数据库大小
python3 /home/spider/31339752/backend/scripts/check_database_size.py

# 检查磁盘空间
df -h

# 检查清理日志
tail -100 /home/spider/31339752/backend/logs/data_cleanup.log
```

---

## 🎉 总结

基于您的服务器配置（24核/62GB/3.6TB）和业务需求（10个C2，每天100万条数据），**推荐保留180天数据**：

- ✅ 存储压力小（仅3%磁盘）
- ✅ 查询性能好
- ✅ 满足半年期分析需求  
- ✅ 自动化运维简单

---

**相关文档**:
- 详细分析: `数据保留期建议.md`
- 使用手册: `数据清理使用指南.md`

**生成时间**: 2025-01-21
