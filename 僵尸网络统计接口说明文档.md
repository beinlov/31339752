# 僵尸网络统计接口说明文档

## 目录

- [文档信息](#文档信息)
- [概述](#概述)
- [快速开始](#快速开始)
- [接口详情](#接口详情)
  - [1. 获取僵尸网络概览统计](#1-获取僵尸网络概览统计)
  - [2. 获取僵尸网络详细信息](#2-获取僵尸网络详细信息)
  - [3. 获取指定僵尸网络节点统计](#3-获取指定僵尸网络节点统计)
  - [3.1. 获取所有僵尸网络节点统计（批量）](#31-获取所有僵尸网络节点统计批量)
  - [4. 获取僵尸网络节点详细信息](#4-获取僵尸网络节点详细信息)
  - [4.1. 获取所有僵尸网络节点详细信息（批量）](#41-获取所有僵尸网络节点详细信息批量)
- [数据表说明](#数据表说明)
- [重要说明](#重要说明)
- [错误码说明](#错误码说明)
- [调用示例](#调用示例)
- [接口总览表](#接口总览表)
- [常见问题 (FAQ)](#常见问题-faq)
- [版本历史](#版本历史)

---

## 文档信息

- **版本**: v1.1
- **更新日期**: 2025-12-11
- **基础路径**: `/api/stats`
- **协议**: HTTP/HTTPS
- **数据格式**: JSON

## 概述

本文档描述了僵尸网络监控平台对外提供的统计数据接口。这些接口用于向其他平台提供已接管僵尸网络的相关数据，包括：

- 僵尸网络基本信息（数量、名称、描述）
- 节点统计数据（总数、地理分布）
- 节点详细信息（IP、位置、ISP等）

### 数据表映射关系

| 接口 | 数据来源表 | 说明 |
|------|-----------|------|
| botnet-summary | botnet_types + 聚合表 | 概览统计 |
| botnet-details | botnet_types + 聚合表 | 详细信息 |
| botnet-node-stats | china_botnet_* + global_botnet_* | 节点统计 |
| botnet-nodes | botnet_nodes_* | 节点详情 |

## 快速开始

### 基础URL

```
http://localhost:8000/api/stats
```

### 认证方式

当前版本暂无认证要求（后续版本可能添加API Key认证）。

## 接口详情

### 1. 获取僵尸网络概览统计

**接口路径**: `GET /api/stats/botnet-summary`

**功能说明**: 获取已接管僵尸网络的概览统计数据，包括僵尸网络总数、名称列表、节点总数等。

**请求参数**: 无

**响应参数**:

| 参数名 | 类型 | 说明 |
|--------|------|------|
| total_botnets | int | 僵尸网络总数 |
| botnet_names | array | 僵尸网络名称列表 |
| total_nodes | int | 节点总数 |
| china_nodes | int | 中国节点数 |
| global_nodes | int | 全球节点数（不含中国） |
| last_updated | string | 最后更新时间 |

**响应示例**:

```json
{
  "total_botnets": 6,
  "botnet_names": ["mozi", "asruex", "andromeda", "ramnit", "leethozer", "moobot"],
  "total_nodes": 125680,
  "china_nodes": 87432,
  "global_nodes": 38248,
  "last_updated": "2025-12-10 17:30:00"
}
```

### 2. 获取僵尸网络详细信息

**接口路径**: `GET /api/stats/botnet-details`

**功能说明**: 获取所有僵尸网络的详细信息，包括名称、显示名称、描述、节点统计等。

**请求参数**: 无

**响应参数**: 数组，每个元素包含以下字段

| 参数名 | 类型 | 说明 |
|--------|------|------|
| name | string | 僵尸网络名称 |
| display_name | string | 显示名称 |
| description | string | 描述 |
| total_nodes | int | 节点总数 |
| china_nodes | int | 中国节点数 |
| global_nodes | int | 全球节点数（不含中国） |
| created_at | string | 创建时间 |

**响应示例**:

```json
[
  {
    "name": "mozi",
    "display_name": "Mozi僵尸网络",
    "description": "基于P2P架构的IoT僵尸网络，主要感染路由器、DVR等设备",
    "total_nodes": 45680,
    "china_nodes": 32450,
    "global_nodes": 13230,
    "created_at": "2025-01-15 09:30:00"
  },
  {
    "name": "asruex",
    "display_name": "Asruex僵尸网络",
    "description": "针对Windows系统的僵尸网络，通过钓鱼邮件传播",
    "total_nodes": 28760,
    "china_nodes": 18920,
    "global_nodes": 9840,
    "created_at": "2025-02-20 14:15:00"
  }
]
```

### 3. 获取指定僵尸网络节点统计

**接口路径**: `GET /api/stats/botnet-node-stats/{botnet_name}`

**功能说明**: 获取指定僵尸网络的节点统计信息，包括节点数量和地理分布（基于聚合表的统计数据）。

**请求参数**:

| 参数名 | 类型 | 位置 | 是否必须 | 说明 |
|--------|------|------|----------|------|
| botnet_name | string | 路径 | 是 | 僵尸网络名称（如：mozi、asruex） |

**响应参数**:

| 参数名 | 类型 | 说明 |
|--------|------|------|
| name | string | 僵尸网络名称 |
| display_name | string | 显示名称 |
| total_nodes | int | 节点总数 |
| china_nodes | int | 中国节点数 |
| global_nodes | int | 全球节点数（不含中国） |
| province_distribution | object | 省份分布 {省份名: 数量} |
| country_distribution | object | 国家分布 {国家名: 数量} |

**响应示例**:

```json
{
  "name": "mozi",
  "display_name": "Mozi僵尸网络",
  "total_nodes": 45680,
  "china_nodes": 32450,
  "global_nodes": 13230,
  "province_distribution": {
    "北京市": 3245,
    "广东省": 5678,
    "江苏省": 4321,
    "浙江省": 3987
  },
  "country_distribution": {
    "中国": 32450,
    "美国": 4560,
    "印度": 3210,
    "巴西": 1980,
    "俄罗斯": 1750
  }
}
```

---

### 3.1. 获取所有僵尸网络节点统计（批量）

**接口路径**: `GET /api/stats/all-botnet-node-stats`

**功能说明**: 一键获取所有僵尸网络的节点统计信息，无需指定僵尸网络名称，返回所有china_botnet_*和global_botnet_*表的统计数据。

**请求参数**: 无

**响应参数**: 数组，每个元素包含以下字段

| 参数名 | 类型 | 说明 |
|--------|------|------|
| name | string | 僵尸网络名称 |
| display_name | string | 显示名称 |
| total_nodes | int | 节点总数 |
| china_nodes | int | 中国节点数 |
| global_nodes | int | 全球节点数（不含中国） |
| province_distribution | object | 省份分布 {省份名: 数量} |
| country_distribution | object | 国家分布 {国家名: 数量} |

**响应示例**:

```json
[
  {
    "name": "mozi",
    "display_name": "Mozi僵尸网络",
    "total_nodes": 45680,
    "china_nodes": 32450,
    "global_nodes": 13230,
    "province_distribution": {
      "北京市": 3245,
      "广东省": 5678,
      "江苏省": 4321,
      "浙江省": 3987
    },
    "country_distribution": {
      "中国": 32450,
      "美国": 4560,
      "印度": 3210,
      "巴西": 1980,
      "俄罗斯": 1750
    }
  },
  {
    "name": "asruex",
    "display_name": "Asruex僵尸网络",
    "total_nodes": 28760,
    "china_nodes": 18920,
    "global_nodes": 9840,
    "province_distribution": {
      "北京市": 2150,
      "上海市": 3200,
      "广东省": 4500
    },
    "country_distribution": {
      "中国": 18920,
      "美国": 3500,
      "日本": 2100
    }
  }
]
```

---

### 4. 获取僵尸网络节点详细信息

**接口路径**: `GET /api/stats/botnet-nodes/{botnet_name}`

**功能说明**: 获取指定僵尸网络的节点详细信息，包括IP、经纬度、地理位置、ISP等（从botnet_nodes_botnetname表）。

**请求参数**:

| 参数名 | 类型 | 是否必须 | 说明 |
|--------|------|----------|------|
| botnet_name | string | 是（路径参数） | 僵尸网络名称 |
| page | int | 否 | 页码，默认1 |
| page_size | int | 否 | 每页条数，默认50 |
| status | string | 否 | 状态过滤（active/inactive） |
| country | string | 否 | 国家过滤 |
| province | string | 否 | 省份过滤 |
| city | string | 否 | 城市过滤 |

**响应参数**:

| 参数名 | 类型 | 说明 |
|--------|------|------|
| status | string | 响应状态 |
| data | object | 数据对象 |
| data.botnet_name | string | 僵尸网络名称 |
| data.display_name | string | 显示名称 |
| data.nodes | array | 节点列表 |
| data.pagination | object | 分页信息 |

**节点对象字段**:

| 参数名 | 类型 | 说明 |
|--------|------|------|
| id | string | 节点ID |
| ip | string | IP地址 |
| longitude | float | 经度 |
| latitude | float | 纬度 |
| country | string | 国家 |
| province | string | 省份 |
| city | string | 城市 |
| continent | string | 大洲 |
| isp | string | ISP运营商 |
| asn | string | ASN号 |
| status | string | 状态 |
| active_time | string | 活跃时间 |
| created_time | string | 创建时间 |
| updated_at | string | 更新时间 |

**响应示例**:

```json
{
  "status": "success",
  "data": {
    "botnet_name": "mozi",
    "display_name": "Mozi僵尸网络",
    "nodes": [
      {
        "id": "193.10.173.5",
        "ip": "193.10.173.5",
        "longitude": 114.195,
        "latitude": 22.3366,
        "country": "中国",
        "province": "广东省",
        "city": "深圳市",
        "continent": "亚洲",
        "isp": "电信",
        "asn": "AS4134",
        "status": "active",
        "active_time": "2025-06-22 20:51:44",
        "created_time": "2025-06-22 20:51:44",
        "updated_at": "2025-06-23 23:14:44"
      }
    ],
    "pagination": {
      "current_page": 1,
      "page_size": 50,
      "total_pages": 914,
      "total_count": 45680
    }
  }
}
```

---

### 4.1. 获取所有僵尸网络节点详细信息（批量）

**接口路径**: `GET /api/stats/all-botnet-nodes`

**功能说明**: 一键获取所有僵尸网络的节点详细信息，无需指定僵尸网络名称，返回所有botnet_nodes_*表的节点数据。

**请求参数**:

| 参数名 | 类型 | 是否必须 | 说明 |
|--------|------|----------|------|
| page | int | 否 | 页码，默认1 |
| page_size | int | 否 | 每页条数，默认50 |
| status | string | 否 | 状态过滤（active/inactive） |
| country | string | 否 | 国家过滤 |
| province | string | 否 | 省份过滤 |
| city | string | 否 | 城市过滤 |

**响应参数**:

| 参数名 | 类型 | 说明 |
|--------|------|------|
| status | string | 响应状态 |
| data | object | 数据对象 |
| data.nodes | array | 所有僵尸网络的节点列表 |
| data.pagination | object | 分页信息 |

**节点对象字段**:

| 参数名 | 类型 | 说明 |
|--------|------|------|
| botnet_name | string | 所属僵尸网络名称 |
| botnet_display_name | string | 所属僵尸网络显示名称 |
| id | string | 节点ID |
| ip | string | IP地址 |
| longitude | float | 经度 |
| latitude | float | 纬度 |
| country | string | 国家 |
| province | string | 省份 |
| city | string | 城市 |
| continent | string | 大洲 |
| isp | string | ISP运营商 |
| asn | string | ASN号 |
| status | string | 状态 |
| active_time | string | 活跃时间 |
| created_time | string | 创建时间 |
| updated_at | string | 更新时间 |

**响应示例**:

```json
{
  "status": "success",
  "data": {
    "nodes": [
      {
        "botnet_name": "mozi",
        "botnet_display_name": "Mozi僵尸网络",
        "id": "193.10.173.5",
        "ip": "193.10.173.5",
        "longitude": 114.195,
        "latitude": 22.3366,
        "country": "中国",
        "province": "广东省",
        "city": "深圳市",
        "continent": "亚洲",
        "isp": "电信",
        "asn": "AS4134",
        "status": "active",
        "active_time": "2025-06-22 20:51:44",
        "created_time": "2025-06-22 20:51:44",
        "updated_at": "2025-06-23 23:14:44"
      },
      {
        "botnet_name": "asruex",
        "botnet_display_name": "Asruex僵尸网络",
        "id": "45.142.212.61",
        "ip": "45.142.212.61",
        "longitude": 116.407,
        "latitude": 39.904,
        "country": "中国",
        "province": "北京市",
        "city": "北京市",
        "continent": "亚洲",
        "isp": "联通",
        "asn": "AS4837",
        "status": "active",
        "active_time": "2025-06-21 15:30:22",
        "created_time": "2025-06-21 15:30:22",
        "updated_at": "2025-06-22 18:45:33"
      }
    ],
    "pagination": {
      "current_page": 1,
      "page_size": 50,
      "total_pages": 1520,
      "total_count": 75980
    }
  }
}
```

---

## 数据表说明

### 表结构概览

| 表名 | 类型 | 说明 | 主要字段 |
|------|------|------|----------|
| botnet_types | 基础表 | 僵尸网络类型信息 | name, display_name, description, created_at |
| china_botnet_{name} | 聚合表 | 中国区域节点统计 | province, infected_num |
| global_botnet_{name} | 聚合表 | 全球区域节点统计 | country, infected_num |
| botnet_nodes_{name} | 详情表 | 节点详细信息 | id, ip, longitude, latitude, country, province, city, isp, asn, status |

### 表命名规则

- `{name}` 为僵尸网络名称，如 `mozi`、`asruex` 等
- 每个僵尸网络对应三张表：china_botnet_*、global_botnet_*、botnet_nodes_*

## 重要说明

### 数据统计规则

1. **节点计数**: 全球节点数（global_nodes）不包含中国节点数，避免重复统计
2. **数据完整性**: 如果某僵尸网络的数据表不存在，接口会跳过该表，只返回可用数据
3. **时间格式**: 所有时间字段统一使用格式 `YYYY-MM-DD HH:MM:SS`
4. **数值类型**: 节点数量均为整数类型

### 性能建议

1. **分页查询**: 获取节点详情时建议使用分页，避免一次性加载大量数据
2. **过滤条件**: 合理使用过滤参数可以提高查询效率
3. **缓存策略**: 概览统计数据更新频率较低，建议客户端适当缓存

### 数据更新频率

- 僵尸网络基本信息：手动更新
- 节点统计数据：每小时更新
- 节点详细信息：实时更新

## 错误码说明

### HTTP状态码

| 状态码 | 说明 | 常见原因 |
|--------|------|----------|
| 200 | 请求成功 | - |
| 404 | 资源不存在 | 指定的僵尸网络名称不存在 |
| 500 | 服务器错误 | 数据库连接失败、SQL执行错误 |

### 错误响应格式

```json
{
  "detail": "错误详细信息"
}
```

### 常见错误示例

**僵尸网络不存在**:
```json
{
  "detail": "Botnet mozi123 not found"
}
```

**节点表不存在**:
```json
{
  "detail": "Node table for botnet mozi not found"
}
```

## 调用示例

### Python 示例

```python
import requests

# 获取僵尸网络概览统计
response = requests.get('http://localhost:8000/api/stats/botnet-summary')
summary = response.json()
print(f"僵尸网络总数: {summary['total_botnets']}")
print(f"节点总数: {summary['total_nodes']}")

# 获取僵尸网络详细信息
response = requests.get('http://localhost:8000/api/stats/botnet-details')
details = response.json()
for botnet in details:
    print(f"{botnet['display_name']}: {botnet['total_nodes']} 个节点")

# 获取指定僵尸网络节点统计
botnet_name = 'mozi'
response = requests.get(f'http://localhost:8000/api/stats/botnet-node-stats/{botnet_name}')
stats = response.json()
print(f"{stats['display_name']} 中国节点: {stats['china_nodes']}")
print(f"{stats['display_name']} 全球节点: {stats['global_nodes']}")

# 获取僵尸网络节点详细信息（支持分页和过滤）
botnet_name = 'mozi'
params = {
    'page': 1,
    'page_size': 50,
    'status': 'active',
    'country': '中国'
}
response = requests.get(f'http://localhost:8000/api/stats/botnet-nodes/{botnet_name}', params=params)
result = response.json()
print(f"总节点数: {result['data']['pagination']['total_count']}")
for node in result['data']['nodes']:
    print(f"IP: {node['ip']}, 位置: {node['province']} {node['city']}")

# 【新增】获取所有僵尸网络节点统计（批量）
response = requests.get('http://localhost:8000/api/stats/all-botnet-node-stats')
all_stats = response.json()
for botnet_stat in all_stats:
    print(f"{botnet_stat['display_name']}: 总节点 {botnet_stat['total_nodes']}, 中国 {botnet_stat['china_nodes']}, 全球 {botnet_stat['global_nodes']}")

# 【新增】获取所有僵尸网络节点详细信息（批量）
params = {
    'page': 1,
    'page_size': 100,
    'status': 'active'
}
response = requests.get('http://localhost:8000/api/stats/all-botnet-nodes', params=params)
all_nodes = response.json()
print(f"所有僵尸网络总节点数: {all_nodes['data']['pagination']['total_count']}")
for node in all_nodes['data']['nodes']:
    print(f"[{node['botnet_display_name']}] IP: {node['ip']}, 位置: {node['province']} {node['city']}")
```

### JavaScript 示例

```javascript
// 获取僵尸网络概览统计
fetch('http://localhost:8000/api/stats/botnet-summary')
  .then(response => response.json())
  .then(data => {
    console.log(`僵尸网络总数: ${data.total_botnets}`);
    console.log(`节点总数: ${data.total_nodes}`);
  });

// 获取僵尸网络详细信息
fetch('http://localhost:8000/api/stats/botnet-details')
  .then(response => response.json())
  .then(data => {
    data.forEach(botnet => {
      console.log(`${botnet.display_name}: ${botnet.total_nodes} 个节点`);
    });
  });

// 获取指定僵尸网络节点统计
const botnetName = 'mozi';
fetch(`http://localhost:8000/api/stats/botnet-node-stats/${botnetName}`)
  .then(response => response.json())
  .then(data => {
    console.log(`${data.display_name} 中国节点: ${data.china_nodes}`);
    console.log(`${data.display_name} 全球节点: ${data.global_nodes}`);
  });

// 获取僵尸网络节点详细信息（支持分页和过滤）
const botnetName = 'mozi';
const params = new URLSearchParams({
  page: 1,
  page_size: 50,
  status: 'active',
  country: '中国'
});
fetch(`http://localhost:8000/api/stats/botnet-nodes/${botnetName}?${params}`)
  .then(response => response.json())
  .then(result => {
    console.log(`总节点数: ${result.data.pagination.total_count}`);
    result.data.nodes.forEach(node => {
      console.log(`IP: ${node.ip}, 位置: ${node.province} ${node.city}`);
    });
  });

// 【新增】获取所有僵尸网络节点统计（批量）
fetch('http://localhost:8000/api/stats/all-botnet-node-stats')
  .then(response => response.json())
  .then(allStats => {
    allStats.forEach(botnetStat => {
      console.log(`${botnetStat.display_name}: 总节点 ${botnetStat.total_nodes}, 中国 ${botnetStat.china_nodes}, 全球 ${botnetStat.global_nodes}`);
    });
  });

// 【新增】获取所有僵尸网络节点详细信息（批量）
const allNodesParams = new URLSearchParams({
  page: 1,
  page_size: 100,
  status: 'active'
});
fetch(`http://localhost:8000/api/stats/all-botnet-nodes?${allNodesParams}`)
  .then(response => response.json())
  .then(allNodes => {
    console.log(`所有僵尸网络总节点数: ${allNodes.data.pagination.total_count}`);
    allNodes.data.nodes.forEach(node => {
      console.log(`[${node.botnet_display_name}] IP: ${node.ip}, 位置: ${node.province} ${node.city}`);
    });
  });
```

---

## 接口总览表

| 接口名称 | 方法 | 路径 | 主要功能 | 分页支持 |
|---------|------|------|---------|---------|
| 获取概览统计 | GET | /api/stats/botnet-summary | 获取所有僵尸网络的概览数据 | ❌ |
| 获取详细信息 | GET | /api/stats/botnet-details | 获取所有僵尸网络的详细信息 | ❌ |
| 获取节点统计 | GET | /api/stats/botnet-node-stats/{name} | 获取指定僵尸网络的统计和分布 | ❌ |
| **获取所有节点统计（批量）** | GET | /api/stats/all-botnet-node-stats | **一键获取所有僵尸网络的节点统计** | ❌ |
| 获取节点详情 | GET | /api/stats/botnet-nodes/{name} | 获取指定僵尸网络的节点详细信息 | ✅ |
| **获取所有节点详情（批量）** | GET | /api/stats/all-botnet-nodes | **一键获取所有僵尸网络的节点详情** | ✅ |

## 常见问题 (FAQ)

### Q1: 如何获取所有僵尸网络的名称列表？
调用 `/api/stats/botnet-summary` 接口，从返回的 `botnet_names` 字段获取。

### Q2: 如何获取某个僵尸网络的所有节点信息？
调用 `/api/stats/botnet-nodes/{botnet_name}` 接口，通过分页参数逐页获取全部数据。

### Q3: 中国节点数和全球节点数是否有重叠？
没有重叠。`global_nodes` 字段已经排除了中国节点，`total_nodes = china_nodes + global_nodes`。

### Q4: 如何过滤获取特定省份的节点？
在调用 `/api/stats/botnet-nodes/{botnet_name}` 时，添加 `province` 参数，例如：`?province=广东省`。

### Q5: 接口是否需要认证？
当前版本（v1.0）暂不需要认证，后续版本可能会添加API Key认证机制。

### Q6: 如何一次性获取所有僵尸网络的节点统计数据？
调用 `/api/stats/all-botnet-node-stats` 接口，无需指定僵尸网络名称，一键返回所有僵尸网络的统计数据。

### Q7: 批量获取节点详情接口返回的数据是否包含僵尸网络标识？
是的。`/api/stats/all-botnet-nodes` 接口返回的每个节点都包含 `botnet_name` 和 `botnet_display_name` 字段，用于标识该节点所属的僵尸网络。

### Q8: 批量接口和单个接口有什么区别？
- **单个接口**（如 `/api/stats/botnet-nodes/{name}`）：需要指定僵尸网络名称，只返回该僵尸网络的数据
- **批量接口**（如 `/api/stats/all-botnet-nodes`）：无需指定名称，一次性返回所有僵尸网络的数据，适合需要全局视图的场景

## 版本历史

| 版本 | 日期 | 更新内容 |
|------|------|---------|
| v1.1 | 2025-12-11 | 新增2个批量查询接口：`all-botnet-node-stats`（获取所有僵尸网络节点统计）、`all-botnet-nodes`（获取所有僵尸网络节点详情） |
| v1.0 | 2025-12-10 | 初始版本，提供4个基础接口 |

## 联系方式

如有接口使用问题或功能建议，请联系技术支持团队。

---

**文档结束**
