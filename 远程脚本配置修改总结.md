# 远程脚本配置修改总结

## ? 已完成的修改

所有远程部署脚本的API配置已修改完成，现在都指向正确的本地控制平台接口。

---

## ? 修改内容

### 1. gateway_packet_loss.py（网关丢包策略）

**修改前：**
```python
API_BASE_URL = "http://192.168.137.1:5000"
API_ENDPOINT = "/api/packet-loss/export"
```

**修改后：**
```python
API_BASE_URL = "http://192.168.137.1:8000"  # ? 端口改为8000
API_ENDPOINT = "/api/suppression/packet-loss/export"  # ? 添加/api/suppression前缀
```

**功能：** 从控制平台获取丢包策略，应用到iptables实现间歇性丢包

**同步间隔：** 10秒

---

### 2. gateway_black_white.py（网关IP黑名单）

**修改前：**
```python
API_BASE_URL = "http://192.168.137.1:5000"
API_ENDPOINT = "/api/blacklist/ip/export"
```

**修改后：**
```python
API_BASE_URL = "http://192.168.137.1:8000"  # ? 端口改为8000
API_ENDPOINT = "/api/suppression/blacklist/ip/export"  # ? 添加/api/suppression前缀
```

**功能：** 从控制平台获取IP黑名单，使用ipset+iptables实现IP封锁

**同步间隔：** 60秒

---

### 3. dns_black_white.py（DNS域名黑名单）

**修改前：**
```python
API_BASE_URL = "http://192.168.137.1:5000"
API_ENDPOINT = "/api/blacklist/domain/export"
```

**修改后：**
```python
API_BASE_URL = "http://192.168.137.1:8000"  # ? 端口改为8000
API_ENDPOINT = "/api/suppression/blacklist/domain/export"  # ? 添加/api/suppression前缀
```

**功能：** 从控制平台获取域名黑名单，配置dnsmasq实现DNS劫持

**同步间隔：** 300秒（5分钟）

---

## ? 对应的后端API接口

### 1. 丢包策略导出接口

**路径：** `GET /api/suppression/packet-loss/export`

**返回格式：** JSON
```json
{
  "192.168.1.100": 0.3,
  "10.0.0.50": 0.5
}
```

**代码位置：** `backend/router/suppression.py` 第992-1021行

---

### 2. IP黑名单导出接口

**路径：** `GET /api/suppression/blacklist/ip/export`

**返回格式：** 纯文本（每行一个IP）
```
192.168.1.100
10.0.0.50
172.16.0.10
```

**代码位置：** `backend/router/suppression.py` 第942-964行

---

### 3. 域名黑名单导出接口

**路径：** `GET /api/suppression/blacklist/domain/export`

**返回格式：** 纯文本（每行一个域名）
```
example.com
malware.net
badsite.org
```

**代码位置：** `backend/router/suppression.py` 第967-989行

---

## ? 完整架构

```
┌──────────────────────────────────┐
│   本地控制平台                   │
│   IP: 192.168.137.1              │
│   端口: 8000                     │
│                                  │
│  ┌────────────────────────────┐ │
│  │  FastAPI后端               │ │
│  │  - MySQL数据库             │ │
│  │  - 前端管理界面            │ │
│  │                            │ │
│  │  导出接口：                │ │
│  │  ? /packet-loss/export    │ │
│  │  ? /blacklist/ip/export   │ │
│  │  ? /blacklist/domain/export│ │
│  └────────────────────────────┘ │
└──────────────┬───────────────────┘
               │
               │ HTTP GET请求
               │ 定时同步
               
┌──────────────────────────────────┐
│   远程服务器（Linux网关/DNS）    │
│                                  │
│  脚本1: gateway_packet_loss.py   │
│  - 每10秒同步丢包策略            │
│  - 应用iptables规则              │
│                                  │
│  脚本2: gateway_black_white.py   │
│  - 每60秒同步IP黑名单            │
│  - 使用ipset+iptables封锁        │
│                                  │
│  脚本3: dns_black_white.py       │
│  - 每5分钟同步域名黑名单         │
│  - 配置dnsmasq DNS劫持           │
└──────────────────────────────────┘
```

---

## ? 部署步骤

### 步骤1: 确保本地平台正常运行

```bash
# 检查后端是否启动
netstat -ano | findstr :8000

# 测试API接口
curl http://localhost:8000/api/suppression/packet-loss/export
curl http://localhost:8000/api/suppression/blacklist/ip/export
curl http://localhost:8000/api/suppression/blacklist/domain/export
```

---

### 步骤2: 修改脚本中的IP地址

**重要：** 将所有脚本中的 `192.168.137.1` 修改为你的**实际IP地址**

```python
# 在每个脚本的第7-8行
API_BASE_URL = "http://你的实际IP:8000"
```

---

### 步骤3: 部署到远程服务器

#### 3.1 上传脚本

```bash
# 使用scp上传
scp gateway_packet_loss.py root@远程服务器IP:/opt/
scp gateway_black_white.py root@远程服务器IP:/opt/
scp dns_black_white.py root@远程服务器IP:/opt/
```

#### 3.2 安装依赖

```bash
# SSH登录到远程服务器
ssh root@远程服务器IP

# 安装Python依赖
pip3 install requests

# 安装系统工具
sudo apt install ipset iptables dnsmasq  # Debian/Ubuntu
# 或
sudo yum install ipset iptables dnsmasq  # CentOS/RHEL
```

#### 3.3 运行脚本

```bash
# 网关丢包策略（需要是网关设备）
sudo python3 /opt/gateway_packet_loss.py

# IP黑名单（需要是网关设备）
sudo python3 /opt/gateway_black_white.py

# DNS域名黑名单（需要是DNS服务器）
sudo python3 /opt/dns_black_white.py
```

---

## ? 测试验证

### 测试1: 丢包策略

1. **在前端添加丢包策略**
   - IP: 192.168.1.100
   - 丢包率: 30%

2. **观察远程服务器日志**
   ```bash
   # 应该在10秒内看到
   [+] 激活规则: 192.168.1.100 (丢包率: 30.0%)
   ```

3. **验证iptables规则**
   ```bash
   sudo iptables -L INTERMITTENT_DROP -n -v
   ```

---

### 测试2: IP黑名单

1. **在前端添加IP黑名单**
   - IP: 10.0.0.50
   - 描述: 测试黑名单

2. **观察远程服务器日志**
   ```bash
   # 应该在60秒内看到
   [10:30:00] 同步成功！当前黑名单包含 1 个 IP。
   ```

3. **验证ipset**
   ```bash
   sudo ipset list blacklist_set
   ```

---

### 测试3: 域名黑名单

1. **在前端添加域名黑名单**
   - 域名: malware.com
   - 描述: 恶意网站

2. **观察远程服务器日志**
   ```bash
   # 应该在5分钟内看到
   [10:35:00] 检测到更新，正在重启 dnsmasq...
   成功更新 1 条域名记录。
   ```

3. **验证dnsmasq配置**
   ```bash
   cat /etc/dnsmasq.d/dns_blacklist.conf
   ```

---

## ? 配置开机自启动

### 创建systemd服务

#### 丢包策略服务

创建 `/etc/systemd/system/gateway-packet-loss.service`：

```ini
[Unit]
Description=Gateway Packet Loss Policy Sync
After=network.target

[Service]
Type=simple
User=root
ExecStart=/usr/bin/python3 /opt/gateway_packet_loss.py
Restart=always

[Install]
WantedBy=multi-user.target
```

#### IP黑名单服务

创建 `/etc/systemd/system/gateway-ip-blacklist.service`：

```ini
[Unit]
Description=Gateway IP Blacklist Sync
After=network.target

[Service]
Type=simple
User=root
ExecStart=/usr/bin/python3 /opt/gateway_black_white.py
Restart=always

[Install]
WantedBy=multi-user.target
```

#### DNS黑名单服务

创建 `/etc/systemd/system/dns-blacklist.service`：

```ini
[Unit]
Description=DNS Domain Blacklist Sync
After=network.target dnsmasq.service

[Service]
Type=simple
User=root
ExecStart=/usr/bin/python3 /opt/dns_black_white.py
Restart=always

[Install]
WantedBy=multi-user.target
```

#### 启用服务

```bash
# 重新加载systemd
sudo systemctl daemon-reload

# 启用并启动服务
sudo systemctl enable gateway-packet-loss
sudo systemctl start gateway-packet-loss

sudo systemctl enable gateway-ip-blacklist
sudo systemctl start gateway-ip-blacklist

sudo systemctl enable dns-blacklist
sudo systemctl start dns-blacklist

# 查看状态
sudo systemctl status gateway-packet-loss
sudo systemctl status gateway-ip-blacklist
sudo systemctl status dns-blacklist
```

---

## ? 注意事项

### 1. 网络要求
- 远程服务器必须能访问本地平台的IP和8000端口
- 如果是公网部署，需要配置端口转发或使用公网IP

### 2. 权限要求
- 所有脚本都需要root权限运行（sudo）
- iptables、ipset、dnsmasq操作需要root权限

### 3. 服务器角色
- **gateway_packet_loss.py**: 需要部署在网关设备上
- **gateway_black_white.py**: 需要部署在网关设备上
- **dns_black_white.py**: 需要部署在DNS服务器上

### 4. 防火墙配置
- 本地平台需要开放8000端口
- 远程服务器需要能访问本地平台

---

## ? 总结

### 已修改的文件
1. ? `gateway_packet_loss.py` - 端口8000，路径/api/suppression/packet-loss/export
2. ? `gateway_black_white.py` - 端口8000，路径/api/suppression/blacklist/ip/export
3. ? `dns_black_white.py` - 端口8000，路径/api/suppression/blacklist/domain/export

### 对应的API接口
1. ? `/api/suppression/packet-loss/export` - 丢包策略（JSON格式）
2. ? `/api/suppression/blacklist/ip/export` - IP黑名单（纯文本）
3. ? `/api/suppression/blacklist/domain/export` - 域名黑名单（纯文本）

### 同步间隔
- 丢包策略: 10秒
- IP黑名单: 60秒
- 域名黑名单: 300秒（5分钟）

---

**所有配置已完成，现在可以部署到远程服务器了！** ?
