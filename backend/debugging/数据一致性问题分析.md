# æ•°æ®ä¸€è‡´æ€§é—®é¢˜æ·±åº¦åˆ†æ

## é—®é¢˜æè¿°

**å‘ç°**ï¼šçº¦1.32%çš„èŠ‚ç‚¹ï¼ˆ3868ä¸ªï¼‰åªå­˜åœ¨äºèŠ‚ç‚¹è¡¨ï¼Œä½†æ²¡æœ‰é€šä¿¡è®°å½•ã€‚

**ç”¨æˆ·ç–‘é—®**ï¼šä»ä¸šåŠ¡é€»è¾‘ä¸Šè®²ï¼ŒèŠ‚ç‚¹åº”è¯¥æ˜¯é€šè¿‡é€šä¿¡è®°å½•å‘ç°çš„ï¼Œä¸ºä»€ä¹ˆä¼šå‡ºç°æœ‰èŠ‚ç‚¹ä½†æ— é€šä¿¡è®°å½•çš„æƒ…å†µï¼Ÿ

## æ—¥å¿—å¤„ç†å™¨æ•°æ®æµç¨‹åˆ†æ

### å®Œæ•´æ•°æ®å¤„ç†æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     æ•°æ®æ¥æ”¶ä¸è§£æ                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. æ¥æ”¶æ•°æ®ï¼ˆRedisé˜Ÿåˆ—æˆ–ç›´æ¥æ¥æ”¶ï¼‰                             â”‚
â”‚ 2. è§£ææ—¥å¿—æ ¼å¼ï¼ˆparser.pyï¼‰                                  â”‚
â”‚ 3. IPåœ°ç†ä½ç½®å¯ŒåŒ–ï¼ˆenricher.pyï¼‰                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              æ•°æ®åº“å†™å…¥ï¼ˆdb_writer.pyï¼‰                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                               â”‚
â”‚  Step 1: å‡†å¤‡æ•°æ®                                             â”‚
â”‚  â”œâ”€ æ•´ç†èŠ‚ç‚¹ä¿¡æ¯ï¼ˆIPã€ä½ç½®ã€çŠ¶æ€ç­‰ï¼‰                             â”‚
â”‚  â””â”€ è®°å½•æ—¥å¿—æ—¶é—´                                               â”‚
â”‚                                                               â”‚
â”‚  Step 2: å†™å…¥/æ›´æ–°èŠ‚ç‚¹è¡¨ï¼ˆbotnet_nodes_testï¼‰                  â”‚
â”‚  â”œâ”€ 2.1 æ£€æŸ¥IPæ˜¯å¦å·²å­˜åœ¨                                       â”‚
â”‚  â”œâ”€ 2.2 åˆ†ç¦»æ–°IPå’Œæ—§IP                                        â”‚
â”‚  â”œâ”€ 2.3 æ‰¹é‡æ’å…¥æ–°IP (INSERT)                                 â”‚
â”‚  â””â”€ 2.4 æ‰¹é‡æ›´æ–°æ—§IP (UPDATE)                                 â”‚
â”‚                                                               â”‚
â”‚  Step 3: æŸ¥è¯¢node_id                                          â”‚
â”‚  â””â”€ é€šè¿‡IPæŸ¥è¯¢å¯¹åº”çš„node_id                                    â”‚
â”‚                                                               â”‚
â”‚  Step 4: å†™å…¥é€šä¿¡è®°å½•è¡¨ï¼ˆbotnet_communications_testï¼‰          â”‚
â”‚  â”œâ”€ ä½¿ç”¨node_idå…³è”                                           â”‚
â”‚  â”œâ”€ è®°å½•é€šä¿¡æ—¶é—´ã€äº‹ä»¶ç±»å‹ç­‰                                    â”‚
â”‚  â””â”€ æ‰¹é‡æ’å…¥ (INSERT IGNORE)                                  â”‚
â”‚                                                               â”‚
â”‚  Step 5: æäº¤äº‹åŠ¡                                             â”‚
â”‚  â””â”€ conn.commit()                                            â”‚
â”‚                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å…³é”®ä»£ç ä½ç½®

#### 1. èŠ‚ç‚¹è¡¨å†™å…¥ï¼ˆç¬¬918-996è¡Œï¼‰

```python
# Step 2.3: æ‰¹é‡æ’å…¥æ–°IP
insert_sql = f"""
    INSERT INTO {self.node_table} 
    (ip, longitude, latitude, country, province, city, continent, isp, asn, 
     status, first_seen, last_seen, communication_count, is_china)
    VALUES {placeholders}
"""
cursor.execute(insert_sql, flat_params)

# Step 2.4: æ‰¹é‡æ›´æ–°æ—§IP
update_sql = f"""
    UPDATE {self.node_table} SET
        ...
        communication_count = communication_count + 1,
        ...
    WHERE ip = %s
"""
cursor.executemany(update_sql, update_values)
```

#### 2. é€šä¿¡è¡¨å†™å…¥ï¼ˆç¬¬1011-1076è¡Œï¼‰

```python
# Step 3: æŸ¥è¯¢node_id
cursor.execute(
    f"SELECT id, ip FROM {self.node_table} WHERE ip IN ({placeholders})",
    ip_list
)
ip_to_node_id = {row[1]: row[0] for row in cursor.fetchall()}

# Step 4: æ’å…¥é€šä¿¡è®°å½•
for item in prepared_nodes:
    node_id = ip_to_node_id.get(node['ip'])
    
    # âš ï¸ å…³é”®é—®é¢˜ï¼šå¦‚æœæ‰¾ä¸åˆ°node_idï¼Œä¼šè·³è¿‡ï¼
    if node_id is None:
        logger.error(f"Cannot find node_id for IP: {node['ip']}")
        continue  # â† è·³è¿‡å†™å…¥é€šä¿¡è¡¨ï¼Œä½†èŠ‚ç‚¹è¡¨å·²ç»æœ‰æ•°æ®äº†ï¼
    
    comm_values.append((node_id, ...))

# æ‰¹é‡æ’å…¥é€šä¿¡è¡¨
comm_sql_batch = f"""
    INSERT IGNORE INTO {self.communication_table}
    (node_id, ip, communication_time, ...)
    VALUES {placeholders}
"""
cursor.execute(comm_sql_batch, flat_params)
```

#### 3. äº‹åŠ¡æäº¤ï¼ˆç¬¬330è¡Œï¼‰

```python
# æäº¤äº‹åŠ¡
conn.commit()  # â† ä¸€æ¬¡æ€§æäº¤æ‰€æœ‰æ›´æ”¹
```

## å¯èƒ½å¯¼è‡´æ•°æ®ä¸ä¸€è‡´çš„åœºæ™¯

### åœºæ™¯1ï¼šç³»ç»Ÿå¼‚å¸¸ä¸­æ–­ï¼ˆæœ€å¯èƒ½ï¼‰â­

**å‘ç”Ÿæ—¶æœº**ï¼šåœ¨Step 2ï¼ˆå†™å…¥èŠ‚ç‚¹è¡¨ï¼‰å®Œæˆåï¼ŒStep 4ï¼ˆå†™å…¥é€šä¿¡è¡¨ï¼‰ä¹‹å‰

**åŸå› **ï¼š
- ç¨‹åºå´©æºƒ
- æœåŠ¡å™¨é‡å¯
- æ•°æ®åº“è¿æ¥æ–­å¼€
- è¿›ç¨‹è¢«å¼ºåˆ¶ç»ˆæ­¢ï¼ˆCtrl+Cã€kill -9ç­‰ï¼‰

**ç»“æœ**ï¼š
- èŠ‚ç‚¹è¡¨ï¼šâœ“ æœ‰æ•°æ®ï¼ˆå·²å†™å…¥ï¼‰
- é€šä¿¡è¡¨ï¼šâœ— æ— æ•°æ®ï¼ˆæœªå†™å…¥ï¼‰

**è¯æ®**ï¼š
```python
# ç¬¬324è¡Œï¼šå…ˆå†™å…¥èŠ‚ç‚¹è¡¨
self._do_insert_nodes_batch_sync(cursor, nodes_to_write)

# ç¬¬330è¡Œï¼šæäº¤äº‹åŠ¡
conn.commit()  # â† å¦‚æœåœ¨è¿™ä¹‹å‰ç³»ç»Ÿå´©æºƒï¼Œæ•°æ®ä¼šä¸¢å¤±
               # â† å¦‚æœåœ¨è¿™ä¹‹åã€å†™å…¥é€šä¿¡è¡¨ä¹‹å‰å´©æºƒï¼ŒèŠ‚ç‚¹è¡¨æœ‰æ•°æ®ä½†é€šä¿¡è¡¨æ— æ•°æ®ï¼
```

**é—®é¢˜æ ¹æº**ï¼š
è™½ç„¶ä»£ç ä¸­æœ‰ `conn.commit()`ï¼Œä½†è¿™ä¸ªcommitæ˜¯åœ¨æ•´ä¸ªflushæ“ä½œçš„æœ€åã€‚å¦‚æœåœ¨commitä¹‹åã€é€šä¿¡è¡¨å†™å…¥ä¹‹å‰ç³»ç»Ÿå¼‚å¸¸ï¼Œå°±ä¼šå¯¼è‡´ä¸ä¸€è‡´ã€‚

### åœºæ™¯2ï¼šnode_idæŸ¥è¯¢å¤±è´¥ï¼ˆè¾ƒå°‘è§ï¼‰

**å‘ç”Ÿæ—¶æœº**ï¼šStep 3æŸ¥è¯¢node_idæ—¶

**åŸå› **ï¼š
```python
# ç¬¬1026-1028è¡Œ
if node_id is None:
    logger.error(f"Cannot find node_id for IP: {node['ip']}")
    continue  # â† è·³è¿‡å†™å…¥é€šä¿¡è¡¨ï¼
```

**å¯èƒ½çš„åŸå› **ï¼š
- æ•°æ®åº“ä¸»ä»åŒæ­¥å»¶è¿Ÿ
- å†™å…¥èŠ‚ç‚¹è¡¨åï¼ŒæŸ¥è¯¢è¿˜æ²¡æœ‰è¯»å–åˆ°ï¼ˆæå°‘è§ï¼Œå› ä¸ºåœ¨åŒä¸€ä¸ªè¿æ¥ä¸­ï¼‰
- ç´¢å¼•é—®é¢˜å¯¼è‡´æŸ¥è¯¢å¤±è´¥

### åœºæ™¯3ï¼šé€šä¿¡è¡¨å†™å…¥å¤±è´¥ï¼ˆè¾ƒå°‘è§ï¼‰

**å‘ç”Ÿæ—¶æœº**ï¼šStep 4å†™å…¥é€šä¿¡è¡¨æ—¶

**åŸå› **ï¼š
- ç£ç›˜ç©ºé—´ä¸è¶³
- è¡¨é”å®š
- ç´¢å¼•å†²çª
- æ•°æ®åº“é™åˆ¶ï¼ˆå¦‚max_allowed_packetï¼‰

**ç‰¹ç‚¹**ï¼š
ä½¿ç”¨ `INSERT IGNORE`ï¼Œå¦‚æœå†™å…¥å¤±è´¥ä¼šé™é»˜è·³è¿‡ï¼Œä¸ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚

### åœºæ™¯4ï¼šäº‹åŠ¡éš”ç¦»é—®é¢˜ï¼ˆç†è®ºå¯èƒ½ï¼‰

**å‘ç”Ÿæ—¶æœº**ï¼šå¹¶å‘å†™å…¥æ—¶

**åŸå› **ï¼š
- å¤šä¸ªworkeråŒæ—¶å†™å…¥åŒä¸€IP
- äº‹åŠ¡éš”ç¦»çº§åˆ«å¯¼è‡´è¯»å–ä¸åˆ°åˆšæ’å…¥çš„æ•°æ®

**å¯èƒ½æ€§**ï¼šè¾ƒä½ï¼Œå› ä¸ºä½¿ç”¨äº†è¿æ¥æ± å’Œæ‰¹é‡å†™å…¥

## å®é™…éªŒè¯

### æ£€æŸ¥ç³»ç»Ÿæ—¥å¿—

è®©æˆ‘ä»¬æ£€æŸ¥æ˜¯å¦æœ‰ç³»ç»Ÿå¼‚å¸¸è®°å½•ï¼š

```bash
# æ£€æŸ¥æ—¥å¿—å¤„ç†å™¨æ—¥å¿—
tail -1000 backend/log_processor/log_processor.log | grep -i "error\|exception\|crash\|killed"

# æ£€æŸ¥æ˜¯å¦æœ‰node_idæŸ¥è¯¢å¤±è´¥çš„è®°å½•
grep "Cannot find node_id" backend/log_processor/log_processor.log
```

### æ•°æ®åº“éªŒè¯

```sql
-- 1. æŸ¥è¯¢æ²¡æœ‰é€šä¿¡è®°å½•çš„èŠ‚ç‚¹
SELECT n.ip, n.country, n.province, n.city, n.created_time, n.first_seen, n.last_seen
FROM botnet_nodes_test n
LEFT JOIN botnet_communications_test c ON n.ip = c.ip
WHERE c.ip IS NULL
LIMIT 20;

-- 2. æ£€æŸ¥è¿™äº›èŠ‚ç‚¹çš„åˆ›å»ºæ—¶é—´åˆ†å¸ƒ
SELECT 
    DATE(first_seen) as date,
    COUNT(*) as count
FROM botnet_nodes_test n
LEFT JOIN botnet_communications_test c ON n.ip = c.ip
WHERE c.ip IS NULL
GROUP BY DATE(first_seen)
ORDER BY date DESC;

-- 3. æ£€æŸ¥æ˜¯å¦å­˜åœ¨æ—¶é—´é›†ä¸­çš„æƒ…å†µï¼ˆå¯èƒ½æ˜¯ç³»ç»Ÿå´©æºƒæ—¶é—´ç‚¹ï¼‰
SELECT 
    DATE_FORMAT(first_seen, '%Y-%m-%d %H:00:00') as hour,
    COUNT(*) as count
FROM botnet_nodes_test n
LEFT JOIN botnet_communications_test c ON n.ip = c.ip
WHERE c.ip IS NULL
GROUP BY hour
ORDER BY count DESC
LIMIT 10;
```

## è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ1ï¼šäº‹åŠ¡æ”¹è¿›ï¼ˆæ¨èï¼‰â­

**ä¿®æ”¹ä½ç½®**ï¼š`db_writer.py` ç¬¬296-365è¡Œ

**ç›®æ ‡**ï¼šç¡®ä¿èŠ‚ç‚¹è¡¨å’Œé€šä¿¡è¡¨åœ¨åŒä¸€ä¸ªäº‹åŠ¡ä¸­ï¼Œè¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥

**å®ç°**ï¼š

```python
def _do_flush_sync(self, nodes_to_write: List[Dict], force: bool):
    """åŒæ­¥æ‰§è¡Œ flush æ“ä½œï¼ˆåœ¨åå°çº¿ç¨‹ä¸­è¿è¡Œï¼‰"""
    conn = None
    try:
        conn = self.connection_pool.get_connection()
        cursor = conn.cursor()
        
        # å¼€å¯äº‹åŠ¡
        conn.begin()  # â† æ˜¾å¼å¼€å¯äº‹åŠ¡
        
        # ç¡®ä¿è¡¨å­˜åœ¨
        if not self.table_created:
            self._ensure_tables_exist_sync(cursor)
            self.table_created = True
        
        # æ‰¹é‡æ’å…¥èŠ‚ç‚¹æ•°æ®
        self._do_insert_nodes_batch_sync(cursor, nodes_to_write)
        
        # âš ï¸ é‡è¦ï¼šåœ¨åŒä¸€ä¸ªäº‹åŠ¡ä¸­æäº¤
        # ä¸è¦åœ¨è¿™é‡Œcommitï¼
        # conn.commit()  # â† åˆ é™¤è¿™è¡Œ
        
    except Exception as e:
        logger.error(f"Error in batch insert: {e}", exc_info=True)
        if conn:
            conn.rollback()  # â† å›æ»šæ‰€æœ‰æ›´æ”¹
        raise
    finally:
        if conn:
            self.connection_pool.return_connection(conn)
```

**ä¿®æ”¹ `_do_insert_nodes_batch_sync` æ–¹æ³•**ï¼š

```python
def _do_insert_nodes_batch_sync(self, cursor, prepared_nodes):
    """æ‰¹é‡æ’å…¥èŠ‚ç‚¹å’Œé€šä¿¡è®°å½•ï¼ˆåŒä¸€äº‹åŠ¡ï¼‰"""
    try:
        # Step 1-3: å†™å…¥èŠ‚ç‚¹è¡¨ï¼ˆä¿æŒä¸å˜ï¼‰
        # ...
        
        # Step 4: å†™å…¥é€šä¿¡è¡¨ï¼ˆä¿æŒä¸å˜ï¼‰
        # ...
        
        # âš ï¸ åœ¨è¿™é‡Œä¸€æ¬¡æ€§æäº¤æ‰€æœ‰æ›´æ”¹
        cursor.connection.commit()  # â† ç¡®ä¿èŠ‚ç‚¹è¡¨å’Œé€šä¿¡è¡¨åŒæ—¶æäº¤
        
    except Exception as e:
        # å¦‚æœä»»ä½•æ­¥éª¤å¤±è´¥ï¼Œå›æ»šæ‰€æœ‰æ›´æ”¹
        cursor.connection.rollback()
        raise
```

### æ–¹æ¡ˆ2ï¼šè¡¥å¿æœºåˆ¶ï¼ˆä¸´æ—¶æ–¹æ¡ˆï¼‰

**ç›®æ ‡**ï¼šå®šæœŸæ£€æŸ¥å¹¶è¡¥å……ç¼ºå¤±çš„é€šä¿¡è®°å½•

**å®ç°**ï¼šåˆ›å»ºä¸€ä¸ªå®šæ—¶ä»»åŠ¡

```python
#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
è¡¥å¿ç¼ºå¤±çš„é€šä¿¡è®°å½•
"""
import pymysql
from config import DB_CONFIG

defè¡¥å……é€šä¿¡è®°å½•(botnet_type='test'):
    """ä¸ºæ²¡æœ‰é€šä¿¡è®°å½•çš„èŠ‚ç‚¹è¡¥å……è®°å½•"""
    conn = pymysql.connect(**DB_CONFIG)
    cursor = conn.cursor()
    
    node_table = f"botnet_nodes_{botnet_type}"
    comm_table = f"botnet_communications_{botnet_type}"
    
    # æŸ¥æ‰¾æ²¡æœ‰é€šä¿¡è®°å½•çš„èŠ‚ç‚¹
    sql = f"""
        SELECT n.id, n.ip, n.first_seen, n.longitude, n.latitude,
               n.country, n.province, n.city, n.continent, n.isp, n.asn,
               n.status, n.is_china
        FROM {node_table} n
        LEFT JOIN {comm_table} c ON n.ip = c.ip
        WHERE c.ip IS NULL
    """
    
    cursor.execute(sql)
    missing_nodes = cursor.fetchall()
    
    print(f"æ‰¾åˆ° {len(missing_nodes)} ä¸ªç¼ºå¤±é€šä¿¡è®°å½•çš„èŠ‚ç‚¹")
    
    if missing_nodes:
        # ä¸ºè¿™äº›èŠ‚ç‚¹è¡¥å……é€šä¿¡è®°å½•ï¼ˆä½¿ç”¨first_seenä½œä¸ºé€šä¿¡æ—¶é—´ï¼‰
        comm_sql = f"""
            INSERT IGNORE INTO {comm_table}
            (node_id, ip, communication_time, longitude, latitude, country, province,
             city, continent, isp, asn, event_type, status, is_china)
            VALUES (%s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s)
        """
        
        comm_values = []
        for row in missing_nodes:
            comm_values.append((
                row[0],  # node_id
                row[1],  # ip
                row[2],  # communication_time (ä½¿ç”¨first_seen)
                row[3],  # longitude
                row[4],  # latitude
                row[5],  # country
                row[6],  # province
                row[7],  # city
                row[8],  # continent
                row[9],  # isp
                row[10], # asn
                'è¡¥å¿è®°å½•',  # event_type
                row[11], # status
                row[12]  # is_china
            ))
        
        cursor.executemany(comm_sql, comm_values)
        conn.commit()
        print(f"å·²è¡¥å…… {len(comm_values)} æ¡é€šä¿¡è®°å½•")
    
    cursor.close()
    conn.close()

if __name__ == '__main__':
    è¡¥å……é€šä¿¡è®°å½•('test')
```

### æ–¹æ¡ˆ3ï¼šæ•°æ®éªŒè¯ä¸å‘Šè­¦ï¼ˆé¢„é˜²æ–¹æ¡ˆï¼‰

**ç›®æ ‡**ï¼šå®šæœŸæ£€æŸ¥æ•°æ®ä¸€è‡´æ€§ï¼ŒåŠæ—¶å‘ç°é—®é¢˜

**å®ç°**ï¼š

```python
#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥
"""
def æ£€æŸ¥æ•°æ®ä¸€è‡´æ€§(botnet_type='test'):
    """æ£€æŸ¥èŠ‚ç‚¹è¡¨å’Œé€šä¿¡è¡¨çš„ä¸€è‡´æ€§"""
    conn = pymysql.connect(**DB_CONFIG)
    cursor = conn.cursor()
    
    node_table = f"botnet_nodes_{botnet_type}"
    comm_table = f"botnet_communications_{botnet_type}"
    
    # ç»Ÿè®¡
    cursor.execute(f"SELECT COUNT(DISTINCT ip) FROM {node_table}")
    total_nodes = cursor.fetchone()[0]
    
    cursor.execute(f"SELECT COUNT(DISTINCT ip) FROM {comm_table}")
    nodes_with_comm = cursor.fetchone()[0]
    
    missing = total_nodes - nodes_with_comm
    coverage = nodes_with_comm / total_nodes * 100
    
    print(f"èŠ‚ç‚¹æ€»æ•°: {total_nodes}")
    print(f"æœ‰é€šä¿¡è®°å½•çš„èŠ‚ç‚¹: {nodes_with_comm}")
    print(f"ç¼ºå¤±é€šä¿¡è®°å½•çš„èŠ‚ç‚¹: {missing}")
    print(f"è¦†ç›–ç‡: {coverage:.2f}%")
    
    # å¦‚æœè¦†ç›–ç‡ä½äº95%ï¼Œå‘å‡ºå‘Šè­¦
    if coverage < 95:
        print(f"âš ï¸ è­¦å‘Šï¼šé€šä¿¡è®°å½•è¦†ç›–ç‡è¿‡ä½ ({coverage:.2f}%)")
        print(f"âš ï¸ å»ºè®®ï¼šæ£€æŸ¥æ—¥å¿—å¤„ç†å™¨æ˜¯å¦æ­£å¸¸è¿è¡Œ")
    
    cursor.close()
    conn.close()
```

## ç»“è®º

### æ ¹æœ¬åŸå› 

**æœ€å¯èƒ½çš„åŸå› **ï¼šç³»ç»Ÿåœ¨å†™å…¥èŠ‚ç‚¹è¡¨ä¹‹åã€å†™å…¥é€šä¿¡è¡¨ä¹‹å‰å¼‚å¸¸ä¸­æ–­ã€‚

**è¯æ®**ï¼š
1. ç¼ºå¤±çš„é€šä¿¡è®°å½•å æ¯”å¾ˆå°ï¼ˆ1.32%ï¼‰ï¼Œç¬¦åˆå¶å‘çš„ç³»ç»Ÿå¼‚å¸¸
2. æ•°æ®å†™å…¥æµç¨‹ä¸­ï¼ŒèŠ‚ç‚¹è¡¨å’Œé€šä¿¡è¡¨æ˜¯åˆ†å¼€å†™å…¥çš„
3. å½“å‰ä»£ç åœ¨ä¸¤æ¬¡å†™å…¥ä¹‹é—´æ²¡æœ‰å¼ºåˆ¶çš„åŸå­æ€§ä¿è¯

### è§£å†³å»ºè®®

**çŸ­æœŸæ–¹æ¡ˆï¼ˆç«‹å³æ‰§è¡Œï¼‰**ï¼š
1. âœ… è¿è¡Œè¡¥å¿è„šæœ¬ï¼Œä¸ºç¼ºå¤±çš„èŠ‚ç‚¹è¡¥å……é€šä¿¡è®°å½•
2. âœ… æ·»åŠ æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥ï¼Œå®šæœŸç›‘æ§

**ä¸­æœŸæ–¹æ¡ˆï¼ˆæœ¬å‘¨å®Œæˆï¼‰**ï¼š
1. ğŸ”§ ä¼˜åŒ–äº‹åŠ¡ç®¡ç†ï¼Œç¡®ä¿èŠ‚ç‚¹è¡¨å’Œé€šä¿¡è¡¨åœ¨åŒä¸€äº‹åŠ¡ä¸­æäº¤
2. ğŸ”§ æ·»åŠ å¼‚å¸¸å¤„ç†å’Œé‡è¯•æœºåˆ¶
3. ğŸ”§ å¢åŠ è¯¦ç»†çš„æ—¥å¿—è®°å½•ï¼Œä¾¿äºé—®é¢˜å®šä½

**é•¿æœŸæ–¹æ¡ˆï¼ˆä¸‹ä¸ªç‰ˆæœ¬ï¼‰**ï¼š
1. ğŸš€ è€ƒè™‘ä½¿ç”¨æ•°æ®åº“è§¦å‘å™¨è‡ªåŠ¨è¡¥å……é€šä¿¡è®°å½•
2. ğŸš€ å®ç°è‡ªåŠ¨æ•°æ®ä¿®å¤æœºåˆ¶
3. ğŸš€ æ·»åŠ å®æ—¶æ•°æ®ä¸€è‡´æ€§ç›‘æ§

### æ˜¯å¦æ˜¯Bugï¼Ÿ

**æ˜¯çš„ï¼Œè¿™æ˜¯ä¸€ä¸ªæ•°æ®ä¸€è‡´æ€§Bug**ï¼Œä½†ä¸æ˜¯ä»£ç é€»è¾‘é”™è¯¯ï¼Œè€Œæ˜¯ï¼š
- **äº‹åŠ¡ç®¡ç†ä¸å½“**ï¼šæ²¡æœ‰ä¿è¯èŠ‚ç‚¹è¡¨å’Œé€šä¿¡è¡¨çš„åŸå­æ€§
- **å¼‚å¸¸å¤„ç†ä¸è¶³**ï¼šç³»ç»Ÿå¼‚å¸¸æ—¶ç¼ºå°‘æ•°æ®æ¢å¤æœºåˆ¶
- **ç¼ºå°‘è¡¥å¿æœºåˆ¶**ï¼šæ²¡æœ‰å®šæœŸæ£€æŸ¥å’Œä¿®å¤æ•°æ®ä¸ä¸€è‡´

---

**æ–‡æ¡£åˆ›å»ºæ—¶é—´**: 2026-01-20  
**åˆ†æäººå‘˜**: AI Assistant  
**åƒµå°¸ç½‘ç»œ**: test  
**å—å½±å“èŠ‚ç‚¹æ•°**: 3,868 (1.32%)  
**æ€»èŠ‚ç‚¹æ•°**: 293,037
