# æ—¶é—´å­—æ®µé€»è¾‘ä¿®æ”¹è¯´æ˜

## ğŸ“‹ éœ€æ±‚è¯´æ˜

### èŠ‚ç‚¹åŸå§‹è¡¨ (`botnet_nodes_{type}`)

**ä¸‰ä¸ªæ—¶é—´å­—æ®µ**:

| å­—æ®µ | è¯´æ˜ | é€»è¾‘ |
|------|------|------|
| `last_active` | æœ€åä¸€æ¬¡èŠ‚ç‚¹statusä¸ºactiveçš„æ—¶é—´ | status='active'æ—¶æ›´æ–°ä¸ºå½“å‰æ—¶é—´ |
| `created_at` | èŠ‚ç‚¹ç¬¬ä¸€æ¬¡å†™å…¥æ•°æ®åº“çš„æ—¶é—´ | é¦–æ¬¡INSERTæ—¶è®¾ç½®,UPDATEæ—¶ä¿æŒä¸å˜ |
| `updated_at` | èŠ‚ç‚¹æœ€è¿‘ä¸€æ¬¡æ›´æ–°åˆ°æ•°æ®åº“çš„æ—¶é—´ | æ¯æ¬¡INSERTæˆ–UPDATEæ—¶æ›´æ–° |

**é‡å¤å†™å…¥é€»è¾‘**:
- åŒä¸€IPå¯èƒ½ä¼šé‡å¤å†™å…¥æ•°æ®è¡¨
- é‡å¤å†™å…¥æ—¶,ä½¿ç”¨æœ€æ–°æ•°æ®è¦†ç›–æ—§æ•°æ®
- `created_at` ä¿æŒç¬¬ä¸€æ¬¡å†™å…¥çš„æ—¶é—´
- `updated_at` æ›´æ–°ä¸ºæœ€æ–°å†™å…¥çš„æ—¶é—´

---

### ç»Ÿè®¡è¡¨ (`china_botnet_{type}` å’Œ `global_botnet_{type}`)

**ä¸¤ä¸ªæ—¶é—´å­—æ®µ**:

| å­—æ®µ | è¯´æ˜ | é€»è¾‘ |
|------|------|------|
| `created_at` | è¯¥åœ°åŒº/å›½å®¶ç¬¬ä¸€ä¸ªèŠ‚ç‚¹çš„åˆ›å»ºæ—¶é—´ | æ¥è‡ªåŸå§‹è¡¨: `MIN(created_at)` |
| `updated_at` | è¯¥åœ°åŒº/å›½å®¶æœ€æ–°èŠ‚ç‚¹çš„æ›´æ–°æ—¶é—´ | æ¥è‡ªåŸå§‹è¡¨: `MAX(updated_at)` |

**å…³é”®ç‚¹**:
- âš ï¸ **æ—¶é—´æ¥è‡ªåŸå§‹è¡¨,è€Œä¸æ˜¯èšåˆæ—¶çš„æ—¶é—´**
- `created_at` = è¯¥åˆ†ç»„ä¸­æœ€æ—©çš„èŠ‚ç‚¹åˆ›å»ºæ—¶é—´
- `updated_at` = è¯¥åˆ†ç»„ä¸­æœ€æ–°çš„èŠ‚ç‚¹æ›´æ–°æ—¶é—´

---

## ğŸ”§ å®ç°æ–¹æ¡ˆ

### 1. èŠ‚ç‚¹åŸå§‹è¡¨ - æ•°æ®åº“è¡¨ç»“æ„

```sql
CREATE TABLE IF NOT EXISTS botnet_nodes_{type} (
    id INT AUTO_INCREMENT PRIMARY KEY,
    ip VARCHAR(15) NOT NULL,
    longitude FLOAT,
    latitude FLOAT,
    country VARCHAR(50),
    province VARCHAR(50),
    city VARCHAR(50),
    continent VARCHAR(50),
    isp VARCHAR(255),
    asn VARCHAR(50),
    status ENUM('active', 'inactive') DEFAULT 'active',
    
    -- æ—¶é—´å­—æ®µ
    last_active TIMESTAMP NULL DEFAULT NULL COMMENT 'æœ€åä¸€æ¬¡statusä¸ºactiveçš„æ—¶é—´',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT 'é¦–æ¬¡å†™å…¥æ—¶é—´',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æœ€è¿‘æ›´æ–°æ—¶é—´',
    
    is_china BOOLEAN DEFAULT FALSE,
    
    -- ç´¢å¼•
    INDEX idx_ip (ip),
    INDEX idx_location (country, province, city),
    INDEX idx_status (status),
    INDEX idx_last_active (last_active),
    INDEX idx_is_china (is_china),
    INDEX idx_created_at (created_at),
    INDEX idx_updated_at (updated_at),
    
    -- å”¯ä¸€çº¦æŸ: åªçº¦æŸIP,å…è®¸åŒä¸€IPçš„é‡å¤å†™å…¥
    UNIQUE KEY idx_unique_ip (ip)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 
COMMENT='åƒµå°¸ç½‘ç»œèŠ‚ç‚¹åŸå§‹æ•°æ®è¡¨';
```

**å…³é”®å˜åŒ–**:
1. âœ… `UNIQUE KEY` ä» `(ip, created_at)` æ”¹ä¸º `(ip)`
2. âœ… `last_active` å…è®¸ `NULL`
3. âœ… æ·»åŠ  `created_at` å’Œ `updated_at` ç´¢å¼•

---

### 2. èŠ‚ç‚¹åŸå§‹è¡¨ - æ’å…¥/æ›´æ–°é€»è¾‘

**SQLè¯­å¥** (`db_writer.py`):

```sql
INSERT INTO botnet_nodes_{type} 
(ip, longitude, latitude, country, province, city, continent, isp, asn, 
 status, last_active, is_china, created_at, updated_at)
VALUES (%s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, NOW(), NOW())
ON DUPLICATE KEY UPDATE
    longitude = VALUES(longitude),
    latitude = VALUES(latitude),
    country = VALUES(country),
    province = VALUES(province),
    city = VALUES(city),
    continent = VALUES(continent),
    isp = VALUES(isp),
    asn = VALUES(asn),
    status = VALUES(status),
    last_active = VALUES(last_active),
    is_china = VALUES(is_china),
    updated_at = NOW()
```

**é€»è¾‘è§£æ**:

| åœºæ™¯ | created_at | updated_at | last_active |
|------|------------|------------|-------------|
| **é¦–æ¬¡æ’å…¥** | NOW() | NOW() | NOW() (å¦‚æœstatus=active) |
| **é‡å¤å†™å…¥** | ä¿æŒä¸å˜ | NOW() | NOW() (å¦‚æœstatus=active) |

**ç¤ºä¾‹**:

```python
# é¦–æ¬¡å†™å…¥: 180.254.163.108
# IP: 180.254.163.108
# created_at: 2025-11-04 10:00:00  â† NOW()
# updated_at: 2025-11-04 10:00:00  â† NOW()
# last_active: 2025-11-04 10:00:00  â† NOW() (status=active)

# é‡å¤å†™å…¥: 180.254.163.108 (5åˆ†é’Ÿå)
# IP: 180.254.163.108
# created_at: 2025-11-04 10:00:00  â† ä¿æŒä¸å˜!
# updated_at: 2025-11-04 10:05:00  â† NOW() æ›´æ–°!
# last_active: 2025-11-04 10:05:00  â† NOW() æ›´æ–°!
```

---

### 3. ç»Ÿè®¡è¡¨ - æ•°æ®åº“è¡¨ç»“æ„

```sql
-- ä¸­å›½ç»Ÿè®¡è¡¨
CREATE TABLE IF NOT EXISTS china_botnet_{type} (
    id INT AUTO_INCREMENT PRIMARY KEY,
    province VARCHAR(50) NOT NULL,
    municipality VARCHAR(50) NOT NULL,
    infected_num INT DEFAULT 0 COMMENT 'æ„ŸæŸ“æ•°é‡',
    
    -- æ—¶é—´å­—æ®µ: æ¥è‡ªåŸå§‹è¡¨,ä¸æ˜¯èšåˆæ—¶é—´!
    created_at TIMESTAMP NULL DEFAULT NULL COMMENT 'è¯¥åœ°åŒºç¬¬ä¸€ä¸ªèŠ‚ç‚¹çš„åˆ›å»ºæ—¶é—´',
    updated_at TIMESTAMP NULL DEFAULT NULL COMMENT 'è¯¥åœ°åŒºæœ€æ–°èŠ‚ç‚¹çš„æ›´æ–°æ—¶é—´',
    
    UNIQUE KEY idx_location (province, municipality),
    INDEX idx_province (province),
    INDEX idx_infected_num (infected_num),
    INDEX idx_created_at (created_at),
    INDEX idx_updated_at (updated_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 
COMMENT='ä¸­å›½åœ°åŒºåƒµå°¸ç½‘ç»œç»Ÿè®¡è¡¨(æŒ‰çœå¸‚)';

-- å…¨çƒç»Ÿè®¡è¡¨
CREATE TABLE IF NOT EXISTS global_botnet_{type} (
    id INT AUTO_INCREMENT PRIMARY KEY,
    country VARCHAR(50) NOT NULL,
    infected_num INT DEFAULT 0 COMMENT 'æ„ŸæŸ“æ•°é‡',
    
    -- æ—¶é—´å­—æ®µ: æ¥è‡ªåŸå§‹è¡¨,ä¸æ˜¯èšåˆæ—¶é—´!
    created_at TIMESTAMP NULL DEFAULT NULL COMMENT 'è¯¥å›½å®¶ç¬¬ä¸€ä¸ªèŠ‚ç‚¹çš„åˆ›å»ºæ—¶é—´',
    updated_at TIMESTAMP NULL DEFAULT NULL COMMENT 'è¯¥å›½å®¶æœ€æ–°èŠ‚ç‚¹çš„æ›´æ–°æ—¶é—´',
    
    UNIQUE KEY idx_country (country),
    INDEX idx_infected_num (infected_num),
    INDEX idx_created_at (created_at),
    INDEX idx_updated_at (updated_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 
COMMENT='å…¨çƒåƒµå°¸ç½‘ç»œç»Ÿè®¡è¡¨(æŒ‰å›½å®¶)';
```

**å…³é”®å˜åŒ–**:
1. âœ… `created_at` å’Œ `updated_at` å…è®¸ `NULL`
2. âœ… æ·»åŠ æ—¶é—´å­—æ®µç´¢å¼•
3. âœ… æ·»åŠ  `COMMENT` è¯´æ˜

---

### 4. ç»Ÿè®¡è¡¨ - èšåˆé€»è¾‘

**ä¸­å›½ç»Ÿè®¡è¡¨èšåˆ** (`aggregator.py`):

```sql
INSERT INTO china_botnet_{type} (province, municipality, infected_num, created_at, updated_at)
SELECT 
    COALESCE(TRIM(TRAILING 'çœ' FROM province), 'æœªçŸ¥') as province,
    CASE 
        WHEN city IN ('åŒ—äº¬', 'å¤©æ´¥', 'ä¸Šæµ·', 'é‡åº†') THEN city
        WHEN city IS NOT NULL THEN TRIM(TRAILING 'å¸‚' FROM city)
        ELSE 'æœªçŸ¥'
    END as municipality,
    COUNT(*) as infected_num,
    MIN(created_at) as created_at,    â† æœ€æ—©çš„èŠ‚ç‚¹åˆ›å»ºæ—¶é—´
    MAX(updated_at) as updated_at     â† æœ€æ–°çš„èŠ‚ç‚¹æ›´æ–°æ—¶é—´
FROM botnet_nodes_{type}
WHERE country = 'ä¸­å›½'
GROUP BY ...
```

**å…¨çƒç»Ÿè®¡è¡¨èšåˆ**:

```sql
INSERT INTO global_botnet_{type} (country, infected_num, created_at, updated_at)
SELECT 
    COALESCE(country, 'æœªçŸ¥') as country,
    COUNT(*) as infected_num,
    MIN(created_at) as created_at,    â† æœ€æ—©çš„èŠ‚ç‚¹åˆ›å»ºæ—¶é—´
    MAX(updated_at) as updated_at     â† æœ€æ–°çš„èŠ‚ç‚¹æ›´æ–°æ—¶é—´
FROM botnet_nodes_{type}
GROUP BY country
```

**å…³é”®ç‚¹**:
- âŒ ~~`NOW()` (é”™è¯¯)~~
- âœ… `MIN(created_at)` from åŸå§‹è¡¨
- âœ… `MAX(updated_at)` from åŸå§‹è¡¨

---

## ğŸ“Š æ•°æ®æµç¤ºä¾‹

### åœºæ™¯: æµ™æ±Ÿçœæ­å·å¸‚çš„èŠ‚ç‚¹æ•°æ®

#### åŸå§‹è¡¨æ•°æ®:

| IP | province | city | created_at | updated_at |
|----|----------|------|------------|------------|
| 180.254.163.108 | æµ™æ±Ÿçœ | æ­å·å¸‚ | 2025-11-04 10:00:00 | 2025-11-04 10:05:00 |
| 180.254.163.109 | æµ™æ±Ÿçœ | æ­å·å¸‚ | 2025-11-04 10:10:00 | 2025-11-04 10:10:00 |
| 180.254.163.110 | æµ™æ±Ÿçœ | æ­å·å¸‚ | 2025-11-04 09:50:00 | 2025-11-04 10:15:00 |

#### èšåˆåç»Ÿè®¡è¡¨æ•°æ®:

| province | municipality | infected_num | created_at | updated_at |
|----------|--------------|--------------|------------|------------|
| æµ™æ±Ÿ | æ­å· | 3 | 2025-11-04 **09:50:00** | 2025-11-04 **10:15:00** |

**è§£é‡Š**:
- `created_at`: `MIN(created_at)` = 2025-11-04 09:50:00 (æœ€æ—©çš„èŠ‚ç‚¹)
- `updated_at`: `MAX(updated_at)` = 2025-11-04 10:15:00 (æœ€æ–°æ›´æ–°çš„èŠ‚ç‚¹)
- âŒ **ä¸æ˜¯èšåˆæ‰§è¡Œæ—¶çš„æ—¶é—´!**

---

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### æ­¥éª¤1: å¤‡ä»½æ•°æ®åº“

```bash
# å¤‡ä»½æ•´ä¸ªbotnetæ•°æ®åº“
mysqldump -u root -p botnet > botnet_backup_$(date +%Y%m%d).sql
```

### æ­¥éª¤2: æ‰§è¡Œæ•°æ®åº“è¿ç§»

```bash
cd backend
mysql -u root -p123456 botnet < migrate_time_fields.sql
```

**é¢„æœŸè¾“å‡º**:
```
æ•°æ®åº“è¿ç§»å®Œæˆï¼
UNIQUE KEYå·²ä»(ip, created_at)æ”¹ä¸º(ip)
last_activeå…è®¸NULL
created_atå’Œupdated_atå…è®¸NULL
```

### æ­¥éª¤3: é‡å¯æ—¥å¿—å¤„ç†å™¨

```bash
# åœæ­¢æ—§è¿›ç¨‹ (Ctrl+C)

# å¯åŠ¨æ–°è¿›ç¨‹
cd backend/log_processor
python main.py
```

### æ­¥éª¤4: è¿è¡Œç»Ÿè®¡èšåˆå™¨

```bash
# å•æ¬¡æ‰‹åŠ¨èšåˆ
cd backend/stats_aggregator
python aggregator.py once

# æˆ–å®ˆæŠ¤è¿›ç¨‹æ¨¡å¼
python aggregator.py daemon 30
```

### æ­¥éª¤5: éªŒè¯æ•°æ®

```sql
-- æŸ¥çœ‹èŠ‚ç‚¹è¡¨ç»“æ„
SHOW CREATE TABLE botnet_nodes_ramnit;

-- æŸ¥çœ‹UNIQUEçº¦æŸ
SHOW INDEX FROM botnet_nodes_ramnit WHERE Key_name LIKE '%unique%';

-- æŸ¥çœ‹ç»Ÿè®¡è¡¨æ•°æ®
SELECT province, municipality, infected_num, created_at, updated_at
FROM china_botnet_ramnit
ORDER BY infected_num DESC
LIMIT 10;

-- éªŒè¯æ—¶é—´é€»è¾‘
SELECT 
    province,
    municipality,
    infected_num,
    created_at as stat_created,
    updated_at as stat_updated
FROM china_botnet_ramnit
WHERE province = 'æµ™æ±Ÿ'
ORDER BY municipality;

-- å¯¹æ¯”åŸå§‹è¡¨æ•°æ®
SELECT 
    province,
    city,
    MIN(created_at) as earliest_node,
    MAX(updated_at) as latest_node,
    COUNT(*) as node_count
FROM botnet_nodes_ramnit
WHERE province = 'æµ™æ±Ÿçœ'
GROUP BY province, city;
```

---

## ğŸ“ ä¿®æ”¹æ–‡ä»¶æ¸…å•

| æ–‡ä»¶ | ä¿®æ”¹å†…å®¹ |
|------|---------|
| `backend/log_processor/db_writer.py` | âœ… è¡¨ç»“æ„: UNIQUE KEYæ”¹ä¸º(ip) |
| `backend/log_processor/db_writer.py` | âœ… è¡¨ç»“æ„: last_activeå…è®¸NULL |
| `backend/log_processor/db_writer.py` | âœ… INSERTé€»è¾‘: ä½¿ç”¨ON DUPLICATE KEY UPDATE |
| `backend/log_processor/db_writer.py` | âœ… last_activeé€»è¾‘: status=activeæ—¶è®¾ç½® |
| `backend/stats_aggregator/aggregator.py` | âœ… è¡¨ç»“æ„: created_atå’Œupdated_atå…è®¸NULL |
| `backend/stats_aggregator/aggregator.py` | âœ… èšåˆé€»è¾‘: ä½¿ç”¨MIN/MAXè€Œä¸æ˜¯NOW() |
| `backend/migrate_time_fields.sql` | âœ… æ•°æ®åº“è¿ç§»è„šæœ¬ |

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. UNIQUEçº¦æŸå˜åŒ–

**ä¹‹å‰**: `UNIQUE KEY idx_unique_record (ip, created_at)`
- åŒä¸€IPåœ¨ä¸åŒæ—¶é—´å¯ä»¥æ’å…¥å¤šæ¬¡
- ä½†è¿™å¯¼è‡´å¤§é‡é‡å¤æ•°æ®

**ç°åœ¨**: `UNIQUE KEY idx_unique_ip (ip)`
- åŒä¸€IPåªèƒ½æœ‰ä¸€æ¡è®°å½•
- é‡å¤å†™å…¥æ—¶æ›´æ–°ç°æœ‰è®°å½•

### 2. æ•°æ®å»é‡

å¦‚æœç°æœ‰æ•°æ®åº“ä¸­æœ‰é‡å¤IP,è¿ç§»åéœ€è¦æ¸…ç†:

```sql
-- æŸ¥çœ‹é‡å¤IP
SELECT ip, COUNT(*) as count
FROM botnet_nodes_ramnit
GROUP BY ip
HAVING count > 1
ORDER BY count DESC;

-- ä¿ç•™æ¯ä¸ªIPæœ€æ–°çš„è®°å½•,åˆ é™¤æ—§è®°å½•
DELETE t1 FROM botnet_nodes_ramnit t1
INNER JOIN botnet_nodes_ramnit t2 
WHERE 
    t1.ip = t2.ip AND
    t1.created_at < t2.created_at;
```

### 3. last_activeé€»è¾‘

```python
# statusä¸ºactiveæ—¶è®¾ç½®last_active
last_active = current_time if node['status'] == 'active' else None
```

å¦‚æœèŠ‚ç‚¹çŠ¶æ€ä¸ºinactive,`last_active`ä¿æŒä¸ºNULLæˆ–ä¹‹å‰çš„å€¼ã€‚

### 4. ç»Ÿè®¡è¡¨æ—¶é—´ä¸ä¼š"å›é€€"

ç”±äºä½¿ç”¨ `MIN(created_at)` å’Œ `MAX(updated_at)`:
- `created_at` åªä¼šä¿æŒä¸å˜æˆ–å˜å¾—æ›´æ—©
- `updated_at` åªä¼šä¿æŒä¸å˜æˆ–å˜å¾—æ›´æ™š
- è¿™ç¬¦åˆå®é™…é€»è¾‘

---

## âœ… éªŒè¯æ¸…å•

- [ ] æ•°æ®åº“å¤‡ä»½å®Œæˆ
- [ ] è¿ç§»è„šæœ¬æ‰§è¡ŒæˆåŠŸ
- [ ] èŠ‚ç‚¹è¡¨UNIQUEçº¦æŸå·²æ›´æ”¹ä¸º(ip)
- [ ] èŠ‚ç‚¹è¡¨last_activeå…è®¸NULL
- [ ] ç»Ÿè®¡è¡¨created_atå’Œupdated_atå…è®¸NULL
- [ ] æ—¥å¿—å¤„ç†å™¨é‡å¯æˆåŠŸ
- [ ] æ–°æ•°æ®æ­£å¸¸å†™å…¥
- [ ] é‡å¤IPèƒ½å¤Ÿæ­£ç¡®æ›´æ–°
- [ ] ç»Ÿè®¡èšåˆå™¨è¿è¡ŒæˆåŠŸ
- [ ] ç»Ÿè®¡è¡¨æ—¶é—´æ¥è‡ªåŸå§‹è¡¨(ä¸æ˜¯NOW())

---

## ğŸ¯ æ€»ç»“

### æ ¸å¿ƒæ”¹è¿›

1. **èŠ‚ç‚¹åŸå§‹è¡¨**: æ”¯æŒåŒä¸€IPçš„æ›´æ–°,è€Œä¸æ˜¯é‡å¤æ’å…¥
2. **æ—¶é—´å­—æ®µè¯­ä¹‰æ˜ç¡®**: 
   - `created_at` = é¦–æ¬¡æ—¶é—´
   - `updated_at` = æœ€æ–°æ—¶é—´
   - `last_active` = æœ€åæ´»è·ƒæ—¶é—´
3. **ç»Ÿè®¡è¡¨æ—¶é—´å‡†ç¡®**: æ¥è‡ªåŸå§‹æ•°æ®,ä¸æ˜¯èšåˆæ—¶é—´

### æ•°æ®ä¸€è‡´æ€§

âœ… ç»Ÿè®¡è¡¨çš„æ—¶é—´å­—æ®µä¸åŸå§‹è¡¨ä¿æŒä¸€è‡´
âœ… ä¸ä¼šå› ä¸ºé‡æ–°èšåˆè€Œæ”¹å˜æ—¶é—´æˆ³
âœ… æ—¶é—´å­—æ®µçœŸå®åæ˜ èŠ‚ç‚¹çš„å®é™…åˆ›å»ºå’Œæ›´æ–°æ—¶é—´

**ä¿®æ”¹å®Œæˆ!** ğŸ‰

