# 数据表使用情况分析

## 📊 查询的数据表

以下是你询问的5个数据表的详细使用情况分析:

---

## 1. 📋 `anomaly_reports` - 异常报告表

### 表结构 (推测)
```sql
CREATE TABLE anomaly_reports (
    id INT AUTO_INCREMENT PRIMARY KEY,
    ip VARCHAR(50),
    location VARCHAR(100),
    report_time DATETIME,
    description TEXT,
    severity VARCHAR(20),
    INDEX idx_report_time (report_time)
);
```

### 用途
存储系统检测到的异常行为报告,用于安全监控和威胁分析。

### 代码使用情况

#### ✅ **使用中** - `backend/main.py`

**API端点**: `GET /api/anomaly-reports`

```python
# 第472-507行
@app.get("/api/anomaly-reports")
async def get_anomaly_reports():
    # 查询最近20条异常报告
    # 按时间倒序排列
    # 如果表不存在返回空数组
```

**功能**:
- 返回最近20条异常报告
- 格式化时间为 `YYYY/MM/DD HH:mm`
- 包含字段: id, ip, location, time, description, severity
- 有容错机制:如果表不存在不会报错

#### 🎨 **前端使用** - `fronted/src/components/ReportContent.js`

**功能**:
- 显示异常报告列表
- 支持搜索、日期范围过滤
- 实时刷新异常报告数据
- 可视化展示异常严重程度

### 📌 状态: **活跃使用中**

---

## 2. 📝 `asruex_logs` - Asruex僵尸网络日志表

### 表结构
```sql
CREATE TABLE IF NOT EXISTS asruex_logs (
    id INT AUTO_INCREMENT PRIMARY KEY,
    log_time DATETIME,
    ip VARCHAR(16),
    status VARCHAR(50),
    command VARCHAR(3),
    description VARCHAR(200),
    file_name VARCHAR(50),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_log_time (log_time),
    INDEX idx_ip (ip),
    INDEX idx_command (command)
);
```

### 用途
存储Asruex僵尸网络的原始日志数据,包括节点访问记录、命令执行等。

### 代码使用情况

#### ❌ **已废弃** - 仅在 `backend/old/asruex.py` 中使用

**原位置**: `backend/router/asruex.py` (已移动到 `backend/old/`)

**功能** (旧系统):
1. **创建表**: 在启动监控时自动创建表
2. **插入日志**: 解析日志文件并插入到 `asruex_logs` 表
3. **查询日志**: 提供API端点 `GET /api/asruex/logs` 查询日志
4. **监控控制**: 
   - `GET /api/asruex/start-monitoring` - 启动日志监控
   - `GET /api/asruex/stop-monitoring` - 停止监控
   - `GET /api/asruex/monitoring-status` - 查询监控状态

**被替代方案**:
- ✅ 新系统使用 `log_processor` 模块
- ✅ 数据存入 `botnet_nodes_asruex` 表
- ✅ 统一的日志处理流程

#### 🎨 **前端使用** - `fronted/src/components/AsruexLogViewer.js`

**功能**:
- 显示Asruex日志查看器
- 提供日志统计面板
- 可能调用已废弃的 `/api/asruex/logs` 端点

### ⚠️ 状态: **已废弃,前端可能需要更新**

**建议**:
1. 检查前端是否还在使用 `/api/asruex/logs` 端点
2. 如使用,需要更新为新的API端点
3. 考虑从 `botnet_nodes_asruex` 表读取数据

---

## 3. 🌐 `nodes` - 节点信息表 (待确认)

### 搜索结果
在整个 `backend` 目录中,**没有找到直接使用名为 `nodes` 的表**。

### 可能情况

#### 情况1: 表名混淆
可能是指以下表之一:
- `botnet_nodes_asruex` - Asruex节点表
- `botnet_nodes_mozi` - Mozi节点表
- `botnet_nodes_andromeda` - Andromeda节点表
- `botnet_nodes_moobot` - Moobot节点表
- `botnet_nodes_ramnit` - Ramnit节点表
- `botnet_nodes_leethozer` - Leethozer节点表

这些表的用途:
- 存储各个僵尸网络的节点信息
- 包含IP、地理位置、ISP、ASN等信息
- 由 `log_processor` 自动写入
- 由 `stats_aggregator` 读取并聚合

#### 情况2: 旧表名
可能是早期版本使用的通用节点表,已被弃用。

### 代码中的"nodes"引用

所有"nodes"引用都是指**变量名**或**注释**,而非表名:

1. **`backend/router/node.py`**: 
   - `nodes` 是查询结果的变量名
   - 实际查询的是 `botnet_nodes_{type}` 表

2. **`backend/log_processor/db_writer.py`**:
   - `nodes` 是要插入的数据列表
   - 实际插入到 `botnet_nodes_{type}` 表

3. **日志输出**: "Flushed X nodes to database" - 指节点数量

### 📌 状态: **表不存在或已废弃**

**建议**: 如果数据库中确实有 `nodes` 表,建议检查其数据是否已迁移到新的分类表中。

---

## 4. 🔌 `socks4` - SOCKS4代理表 (未使用)

### 搜索结果
在整个 `backend` 目录和 `fronted` 目录中,**没有找到任何对 `socks4` 表的引用**。

### 可能用途 (推测)
- 存储SOCKS4代理服务器信息
- 可能用于僵尸网络节点的代理功能
- 可能是某个被禁用功能的残留表

### 📌 状态: **未使用,可能是遗留表**

**建议**: 
1. 检查数据库中该表是否有数据
2. 如果无数据且无用途,可以考虑删除
3. 如果有数据,需要确认其用途后再决定

---

## 5. 🗂️ `tmp` - 临时表

### 表结构
```sql
CREATE TABLE tmp (
    id INT,
    ip VARCHAR(16),
    time VARCHAR(25),
    command VARCHAR(3),
    detail VARCHAR(50),
    status VARCHAR(50)
);
```

### 用途
早期测试时使用的临时表,用于验证日志写入功能。

### 代码使用情况

#### ❌ **已废弃** - 仅在 `backend/old/log_db/dblog.py` 中使用

**原位置**: `backend/log_db/dblog.py` (已移动到 `backend/old/`)

**功能** (测试代码):
1. **动态创建**: 如果表不存在则创建
2. **测试写入**: 用于测试日志解析和数据库写入
3. **API端点**: `GET /dblog/{filename}` - 启动文件监控并写入 `tmp` 表

**使用场景**: 
- 仅用于早期开发测试
- 验证文件监控和日志解析功能
- 测试数据库连接

### 📌 状态: **测试代码,已废弃**

**建议**: 可以安全删除该表

---

## 📊 总结表格

| 表名 | 状态 | 位置 | 用途 | 建议 |
|------|------|------|------|------|
| **anomaly_reports** | ✅ 使用中 | `backend/main.py` | 存储异常报告,供前端展示 | 保留,正常使用 |
| **asruex_logs** | ⚠️ 已废弃 | `backend/old/asruex.py` | 旧版Asruex日志存储 | 检查前端是否使用,考虑迁移或删除 |
| **nodes** | ❓ 不存在 | - | 可能是旧表或混淆 | 检查是否为 `botnet_nodes_{type}` 的混淆 |
| **socks4** | ❌ 未使用 | - | 未知用途(可能遗留) | 检查数据后考虑删除 |
| **tmp** | ❌ 已废弃 | `backend/old/log_db/dblog.py` | 早期测试用临时表 | 可以安全删除 |

---

## 🔍 详细代码引用

### `anomaly_reports` 的使用

#### Backend API
```python
# backend/main.py:472-507
@app.get("/api/anomaly-reports")
async def get_anomaly_reports():
    """获取异常报告列表"""
    query = """
        SELECT 
            id, ip, location, 
            DATE_FORMAT(report_time, '%Y/%m/%d %H:%i') as time,
            description, severity
        FROM anomaly_reports
        ORDER BY report_time DESC
        LIMIT 20
    """
```

#### Frontend
```javascript
// fronted/src/components/ReportContent.js
// 用于显示异常报告的React组件
// 调用 /api/anomaly-reports 获取数据
```

### `asruex_logs` 的使用

#### Backend (已废弃)
```python
# backend/old/asruex.py:112-125
CREATE TABLE IF NOT EXISTS asruex_logs (...)

# backend/old/asruex.py:158-168
INSERT INTO asruex_logs (log_time, ip, status, command, description, file_name)
VALUES (...)

# backend/old/asruex.py:266-268
SELECT * FROM asruex_logs ORDER BY log_time DESC LIMIT %s OFFSET %s
```

#### Frontend
```javascript
// fronted/src/components/AsruexLogViewer.js
// Asruex日志查看器组件
// 可能调用 /api/asruex/logs (已废弃端点)
```

### `tmp` 的使用

#### Backend (测试代码,已废弃)
```python
# backend/old/log_db/dblog.py:119-120
INSERT INTO tmp (id, ip, time, command, detail, status) 
VALUES (%s, %s, %s, %s, %s, %s)

# backend/old/log_db/dblog.py:178-181
# 检查表是否存在,不存在则创建
CREATE TABLE tmp(id int, ip varchar(16), ...)
```

---

## 🎯 行动建议

### 立即执行
1. ✅ **保留 `anomaly_reports`** - 正常使用中
2. ⚠️ **检查 `asruex_logs`**:
   - 查看前端 `AsruexLogViewer.js` 是否还在使用
   - 如果使用,更新为从 `botnet_nodes_asruex` 读取
   - 如果不使用,可以删除或归档

### 需要确认
3. ❓ **核实 `nodes` 表**:
   - 连接数据库检查是否存在该表
   - 如果存在,查看表结构和数据
   - 确认是否需要迁移到新的分类表

4. ❌ **处理 `socks4` 表**:
   - 检查表中是否有数据
   - 确认是否有其他地方使用
   - 如无用途考虑删除

### 可以删除
5. 🗑️ **删除 `tmp` 表** - 仅测试使用,已废弃

---

## 📝 检查脚本

可以使用以下SQL查询来检查这些表的状态:

```sql
-- 检查表是否存在
SELECT 
    TABLE_NAME,
    TABLE_ROWS,
    CREATE_TIME,
    UPDATE_TIME,
    DATA_LENGTH
FROM information_schema.TABLES 
WHERE TABLE_SCHEMA = 'botnet' 
AND TABLE_NAME IN ('anomaly_reports', 'asruex_logs', 'nodes', 'socks4', 'tmp');

-- 检查各表的数据量
SELECT 'anomaly_reports' as table_name, COUNT(*) as row_count FROM anomaly_reports
UNION ALL
SELECT 'asruex_logs', COUNT(*) FROM asruex_logs
UNION ALL
SELECT 'nodes', COUNT(*) FROM nodes
UNION ALL
SELECT 'socks4', COUNT(*) FROM socks4
UNION ALL
SELECT 'tmp', COUNT(*) FROM tmp;
```

---

**生成时间**: 2025-11-04  
**分析范围**: backend/ 和 fronted/src/ 目录下的所有代码文件

