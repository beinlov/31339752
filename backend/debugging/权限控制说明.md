# 权限控制实施说明

## 📋 概述

已为系统添加完整的权限控制机制，实现了管理员、操作员、访客三种角色的权限区分。

## 🔐 权限分级

### 1. **管理员（管理员）**
- ✅ 可以访问后台管理页面（`/admin`）
- ✅ 可以访问展示平台页面（`/index`）
- ✅ 可以执行所有僵尸网络操作（清除、抑制、范围清除、设置）
- ✅ 可以管理用户（创建、修改、删除）
- ✅ 可以注册新的僵尸网络类型
- ✅ 可以查看所有数据和统计信息

### 2. **操作员（操作员）**
- ❌ 无法访问后台管理页面
- ✅ 只能访问展示平台页面（`/index`）
- ✅ 可以执行僵尸网络操作（清除、抑制、范围清除、设置）
- ❌ 无法管理用户
- ❌ 无法注册新的僵尸网络类型
- ✅ 可以查看所有数据和统计信息

### 3. **访客（访客）**
- ❌ 无法访问后台管理页面
- ✅ 只能访问展示平台页面（`/index`）
- ❌ 无法执行任何僵尸网络操作（所有操作按钮被禁用）
- ❌ 无法管理用户
- ❌ 无法注册新的僵尸网络类型
- ✅ 只能查看数据和统计信息（只读权限）

## 🛠️ 技术实现

### 后端实现

#### 1. 权限验证中间件（`backend/auth_middleware.py`）

```python
# 核心函数
- verify_token()                    # 验证JWT token
- require_admin()                   # 要求管理员权限
- require_operator_or_admin()       # 要求操作员或管理员权限
- require_role(*allowed_roles)      # 要求特定角色
```

#### 2. API 路由权限保护

**用户管理路由（`router/user.py`）**
```python
@router.post("/users")              # 创建用户 - 需要管理员权限
@router.put("/users/{user_id}")     # 更新用户 - 需要管理员权限
@router.delete("/users/{user_id}")  # 删除用户 - 需要管理员权限
```

**僵尸网络操作路由（`router/botnet.py`）**
```python
@router.post("/botnet-types")       # 注册僵尸网络类型 - 需要管理员权限
@router.post("/clean-botnet")       # 清除操作 - 需要操作员或管理员权限
```

### 前端实现

#### 1. 页面访问控制

**登录跳转（`loginPage.js`）**
```javascript
if (role === '管理员') {
  history.push('/admin');   // 管理员 → 后台管理页面
} else {
  history.push('/index');   // 操作员/访客 → 展示平台
}
```

#### 2. UI 元素控制

**返回按钮（`topPage/index.js`）**
```javascript
// 只有管理员才显示返回按钮
{isAdmin && (
  <BackButton onClick={this.handleBackClick}>
    <span className='back-icon'>←</span>
    <span className='back-text'>返回</span>
  </BackButton>
)}
```

**操作按钮（`Takeover.js`）**
```javascript
// 根据角色禁用操作按钮
const canOperate = userRole === '管理员' || userRole === '操作员';
const isGuest = userRole === '访客';

<Box 
  onClick={canOperate ? handleClean : undefined}
  style={{ 
    opacity: canOperate ? 1 : 0.5, 
    cursor: canOperate ? 'pointer' : 'not-allowed',
    pointerEvents: canOperate ? 'auto' : 'none'
  }}
  title={isGuest ? '访客无操作权限' : ''}
>
```

#### 3. API 请求认证

所有需要权限的API请求都添加了Authorization header：
```javascript
const token = localStorage.getItem('token');
fetch('http://localhost:8000/api/clean-botnet', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'Authorization': `Bearer ${token}`,
  },
  // ...
})
```

## 📊 权限对比表

| 功能 | 管理员 | 操作员 | 访客 |
|-----|-------|-------|-----|
| **页面访问** |
| 后台管理页面 | ✅ | ❌ | ❌ |
| 展示平台页面 | ✅ | ✅ | ✅ |
| **僵尸网络操作** |
| 一键清除 | ✅ | ✅ | ❌ |
| 范围清除 | ✅ | ✅ | ❌ |
| 抑制阻断 | ✅ | ✅ | ❌ |
| 设置 | ✅ | ✅ | ❌ |
| **用户管理** |
| 创建用户 | ✅ | ❌ | ❌ |
| 修改用户 | ✅ | ❌ | ❌ |
| 删除用户 | ✅ | ❌ | ❌ |
| **系统管理** |
| 注册僵尸网络类型 | ✅ | ❌ | ❌ |
| **数据查看** |
| 查看统计数据 | ✅ | ✅ | ✅ |
| 查看日志 | ✅ | ✅ | ✅ |

## 🔒 安全机制

### 1. JWT Token 验证
- 所有需要权限的API都需要有效的JWT token
- Token包含用户名和角色信息
- Token过期后需要重新登录

### 2. 前后端双重验证
- **前端**：UI层面禁用按钮，提升用户体验
- **后端**：API层面强制验证，确保安全性

### 3. 错误处理
- 未认证：返回 401 Unauthorized
- 权限不足：返回 403 Forbidden
- Token过期：返回 401 并提示重新登录

## 📝 使用说明

### 测试不同角色

1. **测试管理员权限**
   - 使用管理员账号登录
   - 验证可以访问后台管理页面
   - 验证可以执行所有操作

2. **测试操作员权限**
   - 使用操作员账号登录
   - 验证只能访问展示平台
   - 验证可以执行僵尸网络操作
   - 验证无法管理用户

3. **测试访客权限**
   - 使用访客账号登录
   - 验证只能访问展示平台
   - 验证所有操作按钮被禁用（半透明显示）
   - 验证鼠标悬停显示"访客无操作权限"提示

## ⚠️ 注意事项

1. **Token 存储**：Token存储在localStorage中，请确保HTTPS连接
2. **Token 过期**：默认过期时间在后端配置，过期后需要重新登录
3. **权限变更**：修改用户角色后，需要重新登录才能生效
4. **API 调用**：所有前端API调用都需要添加Authorization header

## 🚀 后续优化建议

1. 添加权限变更实时通知
2. 实现Token自动刷新机制
3. 添加操作日志审计功能
4. 实现更细粒度的权限控制（如按僵尸网络类型限制）
5. 添加角色管理界面
