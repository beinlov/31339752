# 日志格式说明文档

## 📝 支持的日志格式

日志处理器 (`log_processor`) 支持多种日志格式,会**自动检测和解析**。

---

## 1️⃣ CSV格式 (推荐 - 通用格式)

### 格式规范
```
timestamp,ip,event_type,extra1,extra2,...
```

### 字段说明
- **timestamp**: 时间戳,格式: `YYYY-MM-DD HH:MM:SS`
- **ip**: IP地址,格式: `xxx.xxx.xxx.xxx`
- **event_type**: 事件类型,如: `access`, `connection`, `command` 等
- **extra1, extra2, ...**: 可选的额外字段

### 示例
```
2025-10-30 14:23:45,192.168.1.100,access,/api/command?id=123
2025-10-30 14:24:12,10.0.0.50,connection,established
2025-10-30 14:25:33,172.16.0.20,command,download,file.exe
```

### 适用僵尸网络
- ✅ asruex
- ✅ mozi
- ✅ andromeda
- ✅ moobot
- ✅ leethozer
- ✅ 所有其他类型(通用格式)

---

## 2️⃣ Ramnit格式

### 格式规范
```
YYYY/MM/DD HH:MM:SS 事件描述: IP地址
```

### 字段说明
- **YYYY/MM/DD HH:MM:SS**: 时间戳,使用斜杠分隔的日期
- **事件描述**: 中文或英文描述,冒号前的部分
- **IP地址**: 冒号后的IP地址

### 示例
```
2025/07/03 09:31:24 新IP首次连接: 180.254.163.108
2025/07/03 09:31:24 新IP首次连接: 149.108.184.126
2025/07/03 09:32:15 节点心跳: 192.168.1.100
2025/07/03 09:33:20 命令执行: 10.0.0.50
```

### 自动解析规则
- 时间格式自动转换: `YYYY/MM/DD` → `YYYY-MM-DD`
- 事件类型自动识别:
  - `首次连接` / `新IP` → `first_connection` / `new_ip`
  - `连接` → `connection`
  - `断开` → `disconnect`
  - `上传` → `upload`
  - `下载` → `download`
  - `命令` → `command`
  - `心跳` → `heartbeat`
  - 其他 → `unknown`

### 系统消息自动过滤
以下类型的行会被**自动跳过**,不会写入数据库:
```
---  开头的分隔符
=== 开头的分隔符
包含"服务器"+"启动"的消息
包含"服务器"+"监听"的消息
包含"worker"的消息
```

**示例** (会被跳过的行):
```
2025/07/03 09:31:24
--- 服务器于 2025-07-03 09:31:24 启动。 ---
2025/07/03 09:31:24 服务器已启动，监听地址: 23.27.200.187:447
2025/07/03 09:31:24 已启动 1000 个 worker 来处理连接。
```

### 适用僵尸网络
- ✅ ramnit (专用)

---

## 3️⃣ 通用格式 (兜底解析)

如果上述两种格式都不匹配,解析器会尝试**智能提取**:

### 提取逻辑
1. 使用正则表达式查找IP地址
2. 尝试从行中提取时间戳
3. 如果没有时间戳,使用当前时间
4. 事件类型默认为 `connection`

### 支持的时间格式
- `YYYY/MM/DD HH:MM:SS`
- `YYYY-MM-DD HH:MM:SS`
- `DD/MM/YYYY HH:MM:SS`

### 示例
```
[INFO] 2025-10-30 14:23:45 Client connected from 192.168.1.100
Connected: 10.0.0.50 at 2025/10/30 14:24:12
IP: 172.16.0.20 initiated connection
```

以上三行都能被解析,提取出IP地址和时间戳。

---

## 📊 解析优先级

对于不同僵尸网络类型,解析器的尝试顺序:

### Ramnit僵尸网络
```
1. Ramnit格式 (专用)
    ↓ 失败
2. CSV格式 (通用)
    ↓ 失败
3. 通用格式 (兜底)
```

### 其他僵尸网络
```
1. CSV格式 (通用)
    ↓ 失败
2. 通用格式 (兜底)
```

---

## 🎯 推荐的日志格式

### 对于新系统或可控的日志生成
**推荐使用CSV格式**,因为:
- ✅ 简单明确,易于生成
- ✅ 字段可扩展
- ✅ 解析速度快
- ✅ 适用所有僵尸网络类型

### 对于已有的日志系统
**使用Ramnit格式或自定义格式**:
- ✅ 无需修改现有日志生成代码
- ✅ 解析器会自动适配
- ✅ 智能提取关键信息

---

## 🛠️ 如何添加新的日志格式

如果你有特殊的日志格式,可以修改 `backend/log_processor/parser.py`:

### 步骤1: 添加解析方法
```python
def _parse_custom_format(self, line: str) -> Optional[Dict]:
    """解析自定义格式"""
    # 你的解析逻辑
    pattern = r'你的正则表达式'
    match = re.match(pattern, line)
    
    if match:
        return {
            'timestamp': '...',
            'ip': '...',
            'event_type': '...',
            'extras': [...],
            'botnet_type': self.botnet_type,
            'raw_line': line
        }
    return None
```

### 步骤2: 在parse_line中调用
```python
def parse_line(self, line: str) -> Optional[Dict]:
    # ... 现有代码 ...
    
    # 添加你的格式检测
    if self.botnet_type == 'your_botnet_type':
        parsed_data = self._parse_custom_format(line)
        if parsed_data:
            return parsed_data
    
    # ... 继续其他格式 ...
```

---

## 📋 完整示例

### 示例1: Asruex僵尸网络 (CSV格式)
```
2025-10-30 14:23:45,192.168.1.100,access,/content/faq.php?&ql=b2
2025-10-30 14:24:12,10.0.0.50,access,/content/faq.php?&ql=a5
2025-10-30 14:25:33,172.16.0.20,access,/content/faq.php?&ql=b0
```

### 示例2: Ramnit僵尸网络 (Ramnit格式)
```
2025/07/03 09:31:24 新IP首次连接: 180.254.163.108
2025/07/03 09:31:24 新IP首次连接: 149.108.184.126
2025/07/03 09:32:15 节点心跳: 192.168.1.100
```

### 示例3: Mozi僵尸网络 (CSV格式)
```
2025-10-30 08:54:50,103.175.4.109,connection,bot_join
2025-10-30 08:54:51,125.160.246.17,heartbeat,alive
2025-10-30 08:54:52,49.48.104.106,command,ddos_start
```

---

## ⚙️ 配置文件

日志格式相关配置在 `backend/log_processor/config.py`:

```python
BOTNET_CONFIG = {
    'ramnit': {
        'enabled': True,
        'log_dir': './backend/logs/ramnit',
        'important_events': []  # 空列表表示保存所有事件
    },
    'asruex': {
        'enabled': True,
        'log_dir': './backend/logs/asruex',
        'important_events': ['access']  # 只保存access事件
    },
    # ... 其他僵尸网络
}
```

---

## 🔍 调试和验证

### 查看解析日志
日志处理器的输出会显示解析状态:
```
✅ 成功: INFO - [ramnit] Processing 100 new lines from 2025-10-30.txt
⚠️ 跳过: WARNING - [ramnit] Invalid log format: (系统消息被跳过)
❌ 失败: ERROR - [ramnit] Error parsing line: (真正的错误)
```

### 测试解析器
可以创建一个测试脚本:
```python
from log_processor.parser import LogParser

parser = LogParser('ramnit')

# 测试Ramnit格式
line1 = "2025/07/03 09:31:24 新IP首次连接: 180.254.163.108"
result1 = parser.parse_line(line1)
print(result1)

# 测试CSV格式
line2 = "2025-10-30 14:23:45,192.168.1.100,access,/api/test"
result2 = parser.parse_line(line2)
print(result2)
```

---

## ❓ 常见问题

### Q1: 我的日志格式不被支持怎么办?
**A**: 解析器有三层保护:
1. 专用格式解析(如Ramnit)
2. CSV通用格式
3. 智能提取(只要有IP就能解析)

如果都失败,可以按照上面的步骤添加自定义格式。

### Q2: 系统消息被写入数据库了怎么办?
**A**: 在 `_is_system_message()` 方法中添加过滤规则:
```python
def _is_system_message(self, line: str) -> bool:
    if '你的系统消息关键词' in line:
        return True
    return False
```

### Q3: 时间格式转换失败怎么办?
**A**: 在 `_extract_timestamp()` 中添加你的时间格式:
```python
patterns = [
    (r'你的正则表达式', '输入格式', '输出格式'),
    # 例如:
    (r'(\d{2}/\d{2}/\d{4})', '%m/%d/%Y', '%Y-%m-%d %H:%M:%S'),
]
```

---

## 📝 总结

| 格式类型 | 适用场景 | 灵活性 | 推荐度 |
|---------|---------|--------|--------|
| **CSV格式** | 新系统,可控日志 | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ |
| **Ramnit格式** | Ramnit专用 | ⭐⭐⭐ | ⭐⭐⭐⭐ |
| **通用格式** | 兜底,不规则日志 | ⭐⭐ | ⭐⭐⭐ |

**最佳实践**: 统一使用CSV格式,解析最快,扩展性最强! 🎯

