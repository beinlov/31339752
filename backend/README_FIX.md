# 🔧 快速修复指南

## 问题说明

你遇到的两个问题：
1. ❌ "中国台湾" 应该显示为 "台湾"
2. ❌ 有601个节点的无名地区（左侧显示不出名称）

**原因**：
- 数据库中province字段可能为NULL或空字符串
- 或者province字段包含"中国台湾"这样的值

## ✅ 一键修复

```bash
# 进入backend目录
cd d:\workspace\botnet\backend

# 运行修复脚本
python fix_region_names.py
```

## 📊 脚本会做什么

### 步骤1: 诊断问题 🔍
脚本会先检查：
- 有多少节点的province为空（这可能就是那601个节点）
- 是否有"中国台湾"、"中国香港"等数据
- 是否有"广西壮族自治区"等不规范命名

**示例输出**:
```
[1/5] 检查并诊断问题数据...

  检查表: botnet_nodes_ramnit
    ⚠️ 发现 601 个节点的province为空
       示例: IP=1.2.3.4, country=中国台湾, city=台北
    ⚠️ 发现country包含'中国'前缀:
       中国台湾: 601 个节点
    ⚠️ 发现不规范的省份名称:
       广西壮族自治区: 150 个节点
```

### 步骤2: 修复数据 🔨
脚本会自动修复：
- ✅ "中国台湾" → "台湾"
- ✅ "中国香港" → "香港"
- ✅ "广西壮族自治区" → "广西"
- ✅ 空的province → "未知"（这样至少能显示出来）

**示例输出**:
```
[2/5] 修复原始节点表中的数据...

  处理表: botnet_nodes_ramnit
    ✓ 统一台湾命名: 601 行
    ✓ 更新 广西壮族自治区: 150 行
    ✓ 填充空province为'未知': 0 行
```

### 步骤3: 清空旧数据 🗑️
```
[3/5] 清空旧的聚合表...
  清空表: china_botnet_ramnit
    ✓ 已清空 34 行
```

### 步骤4: 重新聚合 ♻️
```
[4/5] 重新聚合数据...
  聚合 ramnit...
    ✓ 中国表: 34 行
    ✓ 全球表: 15 行
```

### 步骤5: 验证结果 ✅
```
[5/5] 验证修复结果...
  ✓ ramnit 省份名称已规范化
  ✓ ramnit 国家名称已规范化
  
  ramnit 省份分布 (34 个):
    1. 广西: 601 个节点     # 不再是无名地区！
    2. 江苏: 523 个节点
    3. 广东: 478 个节点
    ...
  
  ramnit 国家分布 (前10):
    1. 中国: 5234 个节点
    2. 台湾: 601 个节点    # 不是"中国台湾"！
    3. 美国: 234 个节点
```

## 🎯 接下来做什么

修复完成后：

### 1. 重新构建前端
```bash
cd d:\workspace\botnet\fronted
npm run build
```

### 2. 重启服务
```bash
# 停止旧进程
Get-Process python | Where-Object {$_.Path -like "*botnet*"} | Stop-Process -Force

# 重新启动
cd d:\workspace\botnet\backend
python main.py
```

### 3. 验证前端

#### 处置平台
访问 http://localhost/disposal
- ✅ 左侧应显示 "广西 601"（不再是空白）
- ✅ 左侧应显示 "台湾"（不是"中国台湾"）
- ✅ 地图上广西、台湾区域有颜色

#### 后台管理系统
访问 http://localhost:3000/admin
- ✅ 饼状图应显示 "台湾: 601"
- ✅ 鼠标悬停应显示正确数量

## ❓ 如果那601个节点仍然显示不出名称

说明原始数据中province字段确实为空或NULL。修复脚本会将它们设置为"未知"：

```sql
-- 手动检查
mysql -u botnet -p -e "
USE botnet_db;
SELECT province, country, COUNT(*) as cnt 
FROM botnet_nodes_ramnit 
GROUP BY province, country 
ORDER BY cnt DESC 
LIMIT 10;
"
```

如果看到：
```
+--------+--------+-----+
| 未知   | 台湾   | 601 |
+--------+--------+-----+
```

说明这些节点的province字段在原始数据中就是空的。这是正常的，至少现在能显示为"未知"了，而不是完全空白。

## 📝 总结

运行 `python fix_region_names.py` 后，你应该看到：
- ✅ "中国台湾" 改为 "台湾"
- ✅ 那601个节点显示为 "广西 601" 或 "未知 601"（取决于原始数据）
- ✅ 所有省份名称统一（无"壮族自治区"等后缀）
- ✅ 地图和列表数据一致

**马上运行脚本试试！** 🚀
