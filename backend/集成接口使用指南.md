# åƒµå°¸ç½‘ç»œæ¥ç®¡å¹³å° - é›†æˆæ¥å£ä½¿ç”¨æŒ‡å—

## ğŸ“‹ æ¦‚è¿°

æœ¬å¹³å°ä½œä¸ºå¤§å‹é›†æˆç³»ç»Ÿçš„å­ç³»ç»Ÿï¼Œæä¾›äº†ä»¥ä¸‹é›†æˆæ¥å£ç”¨äºä¸ä¸»ç³»ç»Ÿå¯¹æ¥:

1. **SSOå…ç™»å½•æ¥å£** - å•ç‚¹ç™»å½•(Single Sign-On)
2. **ç”¨æˆ·æ•°æ®åŒæ­¥æ¥å£** - é›†æˆå¹³å°åŒæ­¥ç”¨æˆ·åˆ°å­ç³»ç»Ÿ
3. **ç”¨æˆ·åˆ é™¤åŒæ­¥æ¥å£** - é›†æˆå¹³å°åˆ é™¤å­ç³»ç»Ÿç”¨æˆ·

## ğŸ”— æ¥å£åˆ—è¡¨

### 1. SSOå…ç™»å½•æ¥å£

| æ¥å£ | æ–¹æ³• | è·¯å¾„ | è¯´æ˜ |
|------|------|------|------|
| SSOç™»å½• | POST | `/api/user/sso-login` | é€šè¿‡ç”¨æˆ·åå¯†ç è·å–è®¿é—®ä»¤ç‰Œ |
| SSOé…ç½®æŸ¥è¯¢ | GET | `/api/user/sso-config` | æŸ¥è¯¢SSOé…ç½®ä¿¡æ¯ |

### 2. ç”¨æˆ·æ•°æ®åŒæ­¥æ¥å£

| æ¥å£ | æ–¹æ³• | è·¯å¾„ | è¯´æ˜ |
|------|------|------|------|
| å•ä¸ªç”¨æˆ·åŒæ­¥ | POST | `/api/user/sync-user` | åŒæ­¥å•ä¸ªç”¨æˆ· |
| æ‰¹é‡ç”¨æˆ·åŒæ­¥ | POST | `/api/user/sync-users-batch` | æ‰¹é‡åŒæ­¥ç”¨æˆ· |
| åˆ é™¤ç”¨æˆ· | DELETE | `/api/user/sync-user` | åˆ é™¤å•ä¸ªç”¨æˆ· |
| æ‰¹é‡åˆ é™¤ç”¨æˆ· | DELETE | `/api/user/sync-users-batch` | æ‰¹é‡åˆ é™¤ç”¨æˆ· |
| åŒæ­¥é…ç½®æŸ¥è¯¢ | GET | `/api/user/sync-config` | æŸ¥è¯¢åŒæ­¥é…ç½®ä¿¡æ¯ |

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### é…ç½®æ–‡ä»¶

ç¼–è¾‘ `backend/config.py`:

```python
# ============================================================
# å…ç™»å½•æ¥å£ï¼ˆSSOï¼‰é…ç½®
# ============================================================

SSO_CONFIG = {
    "sso_token_expire_minutes": 60,  # ä»¤ç‰Œæœ‰æ•ˆæœŸï¼ˆåˆ†é’Ÿï¼‰
    "enable_ip_whitelist": False,     # æ˜¯å¦å¯ç”¨IPç™½åå•
    "ip_whitelist": ["127.0.0.1", "localhost"]
}

# ============================================================
# ç”¨æˆ·æ•°æ®åŒæ­¥æ¥å£é…ç½®
# ============================================================

SYNC_CONFIG = {
    "enable_api_key": True,           # æ˜¯å¦å¯ç”¨APIå¯†é’¥éªŒè¯
    "api_key": "your-sync-api-key-here-change-in-production",
    "enable_ip_whitelist": True,      # æ˜¯å¦å¯ç”¨IPç™½åå•
    "ip_whitelist": ["127.0.0.1", "localhost"],
    "default_role": "è®¿å®¢",           # é»˜è®¤ç”¨æˆ·è§’è‰²
    "default_status": "ç¦»çº¿"          # é»˜è®¤ç”¨æˆ·çŠ¶æ€
}
```

### ç¯å¢ƒå»ºè®®

| ç¯å¢ƒ | APIå¯†é’¥ | IPç™½åå• | HTTPS |
|------|---------|---------|-------|
| **å¼€å‘ç¯å¢ƒ** | å¯å…³é—­ | å¯å…³é—­ | å¯é€‰ |
| **æµ‹è¯•ç¯å¢ƒ** | âœ… å¯ç”¨ | âœ… å¯ç”¨ | âœ… å»ºè®® |
| **ç”Ÿäº§ç¯å¢ƒ** | âœ… å¿…é¡» | âœ… å¿…é¡» | âœ… å¿…é¡» |

---

## ğŸ“– æ¥å£è¯¦ç»†æ–‡æ¡£

### 1. SSOå…ç™»å½•æ¥å£

#### 1.1 SSOç™»å½•

**æ¥å£**: `POST /api/user/sso-login`

**è¯·æ±‚ç¤ºä¾‹**:
```bash
curl -X POST "http://localhost:8000/api/user/sso-login" \
  -H "Content-Type: application/json" \
  -d '{
    "username": "admin",
    "password": "admin123",
    "role": "ç®¡ç†å‘˜"
  }'
```

**å“åº”ç¤ºä¾‹**:
```json
{
    "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "token_type": "bearer",
    "role": "ç®¡ç†å‘˜",
    "username": "admin"
}
```

**Pythonå®¢æˆ·ç«¯ç¤ºä¾‹**:
```python
import requests

def sso_login(username, password, role=None):
    url = "http://localhost:8000/api/user/sso-login"
    data = {"username": username, "password": password}
    if role:
        data["role"] = role
    
    response = requests.post(url, json=data)
    response.raise_for_status()
    return response.json()

# ä½¿ç”¨ç¤ºä¾‹
token_data = sso_login("admin", "admin123")
print(f"Token: {token_data['access_token']}")
print(f"Role: {token_data['role']}")
```

---

### 2. ç”¨æˆ·æ•°æ®åŒæ­¥æ¥å£

#### 2.1 å•ä¸ªç”¨æˆ·åŒæ­¥

**æ¥å£**: `POST /api/user/sync-user`

**è¯·æ±‚å¤´**:
```
Content-Type: application/json
X-API-Key: your-sync-api-key-here-change-in-production
```

**è¯·æ±‚ç¤ºä¾‹**:
```bash
curl -X POST "http://localhost:8000/api/user/sync-user" \
  -H "Content-Type: application/json" \
  -H "X-API-Key: your-sync-api-key-here-change-in-production" \
  -d '{
    "username": "admin",
    "password": "admin123",
    "role": "ç®¡ç†å‘˜"
  }'
```

**å“åº”ç¤ºä¾‹**:
```json
{
    "success": true,
    "message": "ç”¨æˆ· admin åŒæ­¥æˆåŠŸï¼ˆå·²åˆ›å»ºï¼‰",
    "username": "admin",
    "action": "created",
    "role": "ç®¡ç†å‘˜"
}
```

**Pythonå®¢æˆ·ç«¯ç¤ºä¾‹**:
```python
import requests

class UserSyncClient:
    def __init__(self, api_url, api_key):
        self.api_url = api_url
        self.api_key = api_key
    
    def sync_user(self, username, password, role=None):
        url = f"{self.api_url}/api/user/sync-user"
        headers = {
            "Content-Type": "application/json",
            "X-API-Key": self.api_key
        }
        data = {"username": username, "password": password}
        if role:
            data["role"] = role
        
        response = requests.post(url, json=data, headers=headers)
        response.raise_for_status()
        return response.json()

# ä½¿ç”¨ç¤ºä¾‹
client = UserSyncClient(
    api_url="http://localhost:8000",
    api_key="your-sync-api-key-here-change-in-production"
)

result = client.sync_user("user1", "password123", role="æ“ä½œå‘˜")
print(f"Action: {result['action']}")  # created æˆ– updated
print(f"Message: {result['message']}")
```

---

#### 2.2 æ‰¹é‡ç”¨æˆ·åŒæ­¥

**æ¥å£**: `POST /api/user/sync-users-batch`

**è¯·æ±‚ç¤ºä¾‹**:
```bash
curl -X POST "http://localhost:8000/api/user/sync-users-batch" \
  -H "Content-Type: application/json" \
  -H "X-API-Key: your-sync-api-key-here-change-in-production" \
  -d '{
    "users": [
      {"username": "admin", "password": "admin123", "role": "ç®¡ç†å‘˜"},
      {"username": "user1", "password": "password123", "role": "æ“ä½œå‘˜"},
      {"username": "user2", "password": "password456"}
    ]
  }'
```

**å“åº”ç¤ºä¾‹**:
```json
{
    "total": 3,
    "success": 2,
    "failed": 1,
    "results": [
        {
            "username": "admin",
            "success": true,
            "action": "created",
            "message": "ç”¨æˆ· admin åŒæ­¥æˆåŠŸï¼ˆå·²åˆ›å»ºï¼‰",
            "role": "ç®¡ç†å‘˜"
        },
        {
            "username": "user1",
            "success": true,
            "action": "updated",
            "message": "ç”¨æˆ· user1 åŒæ­¥æˆåŠŸï¼ˆå·²æ›´æ–°ï¼‰",
            "role": "æ“ä½œå‘˜"
        },
        {
            "username": "user2",
            "success": false,
            "action": "failed",
            "message": "åŒæ­¥å¤±è´¥: ...",
            "role": null
        }
    ]
}
```

---

#### 2.3 åˆ é™¤ç”¨æˆ·

**æ¥å£**: `DELETE /api/user/sync-user`

**è¯·æ±‚ç¤ºä¾‹**:
```bash
curl -X DELETE "http://localhost:8000/api/user/sync-user" \
  -H "Content-Type: application/json" \
  -H "X-API-Key: your-sync-api-key-here-change-in-production" \
  -d '{
    "username": "user1"
  }'
```

**å“åº”ç¤ºä¾‹**:
```json
{
    "success": true,
    "message": "ç”¨æˆ· user1 åˆ é™¤æˆåŠŸ",
    "username": "user1"
}
```

**é”™è¯¯å“åº”**:
```json
{
    "detail": "ä¸èƒ½åˆ é™¤adminç”¨æˆ·"  // æˆ– "ç”¨æˆ·ä¸å­˜åœ¨"
}
```

---

#### 2.4 æ‰¹é‡åˆ é™¤ç”¨æˆ·

**æ¥å£**: `DELETE /api/user/sync-users-batch`

**è¯·æ±‚ç¤ºä¾‹**:
```bash
curl -X DELETE "http://localhost:8000/api/user/sync-users-batch" \
  -H "Content-Type: application/json" \
  -H "X-API-Key: your-sync-api-key-here-change-in-production" \
  -d '{
    "usernames": ["user1", "user2", "user3"]
  }'
```

**å“åº”ç¤ºä¾‹**:
```json
{
    "total": 3,
    "success": 2,
    "failed": 1,
    "results": [
        {
            "username": "user1",
            "success": true,
            "message": "ç”¨æˆ· user1 åˆ é™¤æˆåŠŸ"
        },
        {
            "username": "user2",
            "success": true,
            "message": "ç”¨æˆ· user2 åˆ é™¤æˆåŠŸ"
        },
        {
            "username": "user3",
            "success": false,
            "message": "åˆ é™¤å¤±è´¥: ç”¨æˆ·ä¸å­˜åœ¨"
        }
    ]
}
```

---

## ğŸ”’ å®‰å…¨æœºåˆ¶

### 1. APIå¯†é’¥éªŒè¯ï¼ˆç”¨æˆ·åŒæ­¥æ¥å£ï¼‰

**é…ç½®**:
```python
SYNC_CONFIG = {
    "enable_api_key": True,
    "api_key": "your-sync-api-key-here-change-in-production"
}
```

**ä½¿ç”¨æ–¹å¼**:

- **æ–¹å¼1**: Headerä¼ é€’
  ```
  X-API-Key: your-sync-api-key-here-change-in-production
  ```

- **æ–¹å¼2**: æŸ¥è¯¢å‚æ•°ä¼ é€’
  ```
  /api/user/sync-user?api_key=your-sync-api-key-here-change-in-production
  ```

### 2. IPç™½åå•éªŒè¯

**é…ç½®**:
```python
SSO_CONFIG = {
    "enable_ip_whitelist": True,
    "ip_whitelist": ["192.168.1.100", "10.0.0.50"]
}

SYNC_CONFIG = {
    "enable_ip_whitelist": True,
    "ip_whitelist": ["192.168.1.100", "10.0.0.50"]
}
```

### 3. HTTPSä¼ è¾“ï¼ˆç”Ÿäº§ç¯å¢ƒå¿…éœ€ï¼‰

ç”Ÿäº§ç¯å¢ƒå¿…é¡»ä½¿ç”¨HTTPSåŠ å¯†ä¼ è¾“ï¼Œé˜²æ­¢å¯†ç å’ŒAPIå¯†é’¥åœ¨ä¼ è¾“è¿‡ç¨‹ä¸­è¢«æˆªè·ã€‚

---

## ğŸ“Š é”™è¯¯ç è¯´æ˜

| HTTPçŠ¶æ€ç  | è¯´æ˜ | è§£å†³æ–¹æ¡ˆ |
|-----------|------|----------|
| 200 | æˆåŠŸ | - |
| 400 | ä¸èƒ½åˆ é™¤adminç”¨æˆ· | ä¸è¦å°è¯•åˆ é™¤admin |
| 401 | APIå¯†é’¥éªŒè¯å¤±è´¥æˆ–ç”¨æˆ·åå¯†ç é”™è¯¯ | æ£€æŸ¥APIå¯†é’¥æˆ–å‡­æ® |
| 403 | IPåœ°å€ä¸åœ¨ç™½åå•ä¸­ | è”ç³»ç®¡ç†å‘˜æ·»åŠ IP |
| 404 | ç”¨æˆ·ä¸å­˜åœ¨ | æ£€æŸ¥ç”¨æˆ·å |
| 422 | è¯·æ±‚å‚æ•°éªŒè¯å¤±è´¥ | æ£€æŸ¥è¯·æ±‚å‚æ•°æ ¼å¼ |
| 500 | æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ | æŸ¥çœ‹æœåŠ¡å™¨æ—¥å¿— |

---

## ğŸ§ª æµ‹è¯•å»ºè®®

### å•å…ƒæµ‹è¯•

```python
import pytest
import requests

API_URL = "http://localhost:8000"
API_KEY = "your-sync-api-key-here-change-in-production"

def test_sso_login():
    """æµ‹è¯•SSOç™»å½•"""
    response = requests.post(
        f"{API_URL}/api/user/sso-login",
        json={"username": "admin", "password": "admin123"}
    )
    assert response.status_code == 200
    data = response.json()
    assert "access_token" in data
    assert data["username"] == "admin"

def test_sync_user():
    """æµ‹è¯•ç”¨æˆ·åŒæ­¥"""
    headers = {"X-API-Key": API_KEY}
    response = requests.post(
        f"{API_URL}/api/user/sync-user",
        json={"username": "testuser", "password": "testpass"},
        headers=headers
    )
    assert response.status_code == 200
    data = response.json()
    assert data["success"] == True
    assert data["action"] in ["created", "updated"]

def test_delete_user():
    """æµ‹è¯•åˆ é™¤ç”¨æˆ·"""
    headers = {"X-API-Key": API_KEY}
    # å…ˆåˆ›å»ºç”¨æˆ·
    requests.post(
        f"{API_URL}/api/user/sync-user",
        json={"username": "testuser", "password": "testpass"},
        headers=headers
    )
    # åˆ é™¤ç”¨æˆ·
    response = requests.delete(
        f"{API_URL}/api/user/sync-user",
        json={"username": "testuser"},
        headers=headers
    )
    assert response.status_code == 200
    data = response.json()
    assert data["success"] == True

def test_cannot_delete_admin():
    """æµ‹è¯•ä¸èƒ½åˆ é™¤adminç”¨æˆ·"""
    headers = {"X-API-Key": API_KEY}
    response = requests.delete(
        f"{API_URL}/api/user/sync-user",
        json={"username": "admin"},
        headers=headers
    )
    assert response.status_code == 400
```

---

## ğŸ“š å‚è€ƒæ–‡æ¡£

è¯¦ç»†çš„æ¥å£è®¾è®¡æ–‡æ¡£ä½äº `another` ç›®å½•:

- `another/å…ç™»å½•æ¥å£è®¾è®¡.docx` - SSOæ¥å£Wordæ–‡æ¡£
- `another/ç”¨æˆ·æ•°æ®åŒæ­¥æ¥å£.docx` - ç”¨æˆ·åŒæ­¥æ¥å£Wordæ–‡æ¡£
- `another/è¡¥ï¼šåˆ é™¤ç”¨æˆ·æ•°æ®åŒæ­¥æ¥å£.docx` - åˆ é™¤æ¥å£Wordæ–‡æ¡£
- `another/botnet/backend/SSO_INTEGRATION.md` - SSOé›†æˆMarkdownæ–‡æ¡£
- `another/botnet/backend/USER_SYNC_DESIGN.md` - ç”¨æˆ·åŒæ­¥Markdownæ–‡æ¡£

---

## ğŸ”„ ç‰ˆæœ¬å†å²

### v1.0 (å½“å‰ç‰ˆæœ¬)
- âœ… å®ç°SSOå…ç™»å½•æ¥å£
- âœ… å®ç°å•ä¸ªç”¨æˆ·åŒæ­¥æ¥å£
- âœ… å®ç°æ‰¹é‡ç”¨æˆ·åŒæ­¥æ¥å£
- âœ… å®ç°åˆ é™¤ç”¨æˆ·æ¥å£
- âœ… å®ç°æ‰¹é‡åˆ é™¤ç”¨æˆ·æ¥å£
- âœ… æ”¯æŒAPIå¯†é’¥éªŒè¯
- âœ… æ”¯æŒIPç™½åå•éªŒè¯
- âœ… æ”¯æŒè§’è‰²æ˜ å°„
- âœ… adminç”¨æˆ·ä¿æŠ¤æœºåˆ¶

---

## âš™ï¸ éƒ¨ç½²æ¸…å•

### å¼€å‘ç¯å¢ƒ
- [ ] ä¿®æ”¹ `config.py` ä¸­çš„æ•°æ®åº“é…ç½®
- [ ] å¯åŠ¨FastAPIåç«¯: `cd backend && python main.py`
- [ ] æµ‹è¯•æ¥å£æ˜¯å¦æ­£å¸¸

### ç”Ÿäº§ç¯å¢ƒ
- [ ] ä¿®æ”¹APIå¯†é’¥ä¸ºå¼ºå¯†é’¥ï¼ˆè‡³å°‘32ä¸ªå­—ç¬¦ï¼‰
- [ ] é…ç½®é›†æˆå¹³å°çš„IPåœ°å€åˆ°ç™½åå•
- [ ] å¯ç”¨HTTPSä¼ è¾“
- [ ] å¯ç”¨APIå¯†é’¥éªŒè¯
- [ ] å¯ç”¨IPç™½åå•éªŒè¯
- [ ] è¿›è¡Œå……åˆ†çš„é›†æˆæµ‹è¯•
- [ ] é…ç½®æ—¥å¿—è®°å½•å’Œç›‘æ§
- [ ] è®¾ç½®å¼‚å¸¸å‘Šè­¦

---

## ğŸ’¡ å¸¸è§é—®é¢˜

### Q: å¦‚ä½•ç”Ÿæˆå¼ºAPIå¯†é’¥?
A: ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ç”Ÿæˆ:
```bash
# Linux/Mac
openssl rand -hex 32

# Python
python -c "import secrets; print(secrets.token_hex(32))"
```

### Q: å¦‚ä½•æµ‹è¯•æ¥å£?
A: å¯ä»¥ä½¿ç”¨:
1. cURLå‘½ä»¤è¡Œå·¥å…·
2. Postmanæˆ–ç±»ä¼¼APIæµ‹è¯•å·¥å…·
3. Python requestsåº“
4. æä¾›çš„æµ‹è¯•è„šæœ¬

### Q: ç”¨æˆ·è§’è‰²æœ‰å“ªäº›?
A: æ”¯æŒä»¥ä¸‹è§’è‰²:
- `ç®¡ç†å‘˜` / `admin` - ç®¡ç†å‘˜æƒé™
- `æ“ä½œå‘˜` / `operator` - æ“ä½œå‘˜æƒé™
- `è®¿å®¢` / `viewer` - è®¿å®¢æƒé™ï¼ˆåªè¯»ï¼‰

### Q: å¦‚ä½•æŸ¥çœ‹æ—¥å¿—?
A: æŸ¥çœ‹FastAPIæ—¥å¿—è¾“å‡ºæˆ–é…ç½®çš„æ—¥å¿—æ–‡ä»¶ã€‚

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·æŸ¥çœ‹:
- ç³»ç»Ÿæ—¥å¿—
- æ¥å£æ–‡æ¡£
- é…ç½®æ–‡ä»¶æ³¨é‡Š

**å®Œæˆ!** ğŸ‰ é›†æˆæ¥å£å·²å…¨éƒ¨å®ç°å¹¶å¯ä½¿ç”¨ã€‚


