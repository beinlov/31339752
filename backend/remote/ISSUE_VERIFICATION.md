# æ¨é€æ¨¡å¼é—®é¢˜åœ¨æ‹‰å–æ¨¡å¼ä¸­çš„éªŒè¯

**éªŒè¯æ—¶é—´**: 2024-12-29  
**ç»“è®º**: âœ… æ‰€æœ‰é—®é¢˜éƒ½å·²åœ¨æ‹‰å–æ¨¡å¼ä¸­æ­£ç¡®å¤„ç†

---

## ğŸ“‹ é—®é¢˜åˆ—è¡¨

### é—®é¢˜1: IPå»é‡é—®é¢˜

**éœ€æ±‚**: ä¸èƒ½å»é‡ï¼Œéœ€è¦ä¼ è¾“æ‰€æœ‰æ•°æ®ç”¨äºèŠ‚ç‚¹äº¤äº’ç»Ÿè®¡

#### æ¨é€æ¨¡å¼ï¼ˆremote_uploader.pyï¼‰

âœ… **å·²ä¿®å¤** - ç¬¬730-743è¡Œ

```python
async def process_line(self, line: str, file_path: Path = None):
    """å¤„ç†å•è¡Œæ—¥å¿—ï¼Œæå–IPåœ°å€å’Œæ—¶é—´æˆ³ï¼ˆä¸å†å»é‡ï¼Œä¼ è¾“æ‰€æœ‰æ•°æ®ï¼‰"""
    # ...
    if ip_data:
        log_date = ip_data['date']
        
        # ä¸å†å»é‡ï¼Œç›´æ¥æ·»åŠ æ‰€æœ‰æ•°æ®åˆ°å¾…ä¸Šä¼ é˜Ÿåˆ—
        # defaultdict ä¼šè‡ªåŠ¨åˆ›å»º dequeï¼Œæ— éœ€æ£€æŸ¥
        self.daily_ips_with_time[log_date].append(ip_data)
```

#### æ‹‰å–æ¨¡å¼ï¼ˆc2_data_server.pyï¼‰

âœ… **å·²éªŒè¯** - å®Œå…¨å¤ç”¨ `IPProcessor` çš„é€»è¾‘

```python
# ç¬¬217-224è¡Œ
# ä½¿ç”¨IPProcessorçš„å®Œæ•´è§£æé€»è¾‘ï¼ˆåŒ…å«IPè§„èŒƒåŒ–ï¼‰
ip_data = self.ip_processor.extract_ip_and_timestamp_from_line(
    line, 
    file_path=file_path
)

if ip_data:
    # ip_data å·²ç»åŒ…å«è§„èŒƒåŒ–åçš„IPå’Œå®Œæ•´æ—¶é—´æˆ³ä¿¡æ¯
    new_records.append(ip_data)  # ç›´æ¥æ·»åŠ ï¼Œä¸å»é‡
```

**éªŒè¯ç»“æœ**: âœ… æ‹‰å–æ¨¡å¼åŒæ ·ä¸è¿›è¡Œå»é‡ï¼Œæ‰€æœ‰æ•°æ®éƒ½ä¼šè¢«ä¼ è¾“

---

### é—®é¢˜2: æ—¥å¿—æ–‡ä»¶ç”Ÿæˆé¢‘ç‡

**éœ€æ±‚**: 
- æ”¹ä¸ºæ¯å°æ—¶ç”Ÿæˆä¸€ä¸ªæ—¥å¿—æ–‡ä»¶
- åªä¼ è¾“ä¸Šä¸€å°æ—¶å·²å®Œæ•´çš„æ—¥å¿—æ–‡ä»¶
- å½“å‰å°æ—¶æ­£åœ¨å†™å…¥çš„æ–‡ä»¶ä¸å¤„ç†

#### æ¨é€æ¨¡å¼ï¼ˆremote_uploader.pyï¼‰

âœ… **å·²ä¿®å¤** - ç¬¬226-300è¡Œ

```python
def get_log_file_path(self, datetime_obj: datetime) -> Path:
    """è·å–æŒ‡å®šæ—¶é—´çš„æ—¥å¿—æ–‡ä»¶è·¯å¾„ï¼ˆæŒ‰å°æ—¶ï¼‰"""
    if '{datetime}' in self.file_pattern:
        datetime_str = datetime_obj.strftime('%Y-%m-%d_%H')  # æŒ‰å°æ—¶
        filename = self.file_pattern.format(datetime=datetime_str)
    return self.log_dir / filename

async def get_available_log_files(self, hours_back: int = 720) -> List[Tuple[datetime, Path]]:
    """è·å–å¯ç”¨çš„æ—¥å¿—æ–‡ä»¶åˆ—è¡¨ï¼ˆæŒ‰å°æ—¶ï¼Œåªè¿”å›ä¸Šä¸€å°æ—¶åŠæ›´æ—©çš„æ–‡ä»¶ï¼‰"""
    now = datetime.now()
    current_hour = now.replace(minute=0, second=0, microsecond=0)
    
    # ...
    
    # è§£ææ—¥æœŸæ—¶é—´ï¼ˆæ ¼å¼ï¼šYYYY-MM-DD_HHï¼‰
    file_datetime = datetime.strptime(datetime_str, '%Y-%m-%d_%H')
    
    # è¿‡æ»¤æ¡ä»¶ï¼š
    # 1. ä¸æ—©äº earliest_timeï¼ˆè¿‡æ»¤è¿‡æ—§æ–‡ä»¶ï¼‰
    # 2. æ—©äº current_hourï¼ˆè·³è¿‡å½“å‰å°æ—¶æ­£åœ¨å†™å…¥çš„æ–‡ä»¶ï¼‰
    if file_datetime >= earliest_time and file_datetime < current_hour:
        # é¢å¤–æ£€æŸ¥ï¼šæ–‡ä»¶ä¿®æ”¹æ—¶é—´å¿…é¡»ç¨³å®šï¼ˆé¿å…å»¶è¿Ÿå†™å…¥ï¼‰
        file_mtime = file_path.stat().st_mtime
        time_since_modified = current_time - file_mtime
        
        if time_since_modified >= FILE_STABILITY_MARGIN:  # 300ç§’
            files.append((file_datetime, file_path))
```

**å…³é”®ç‚¹**:
1. æ–‡ä»¶åæ ¼å¼: `ramnit_2024-12-29_15.log` (æŒ‰å°æ—¶)
2. è¿‡æ»¤å½“å‰å°æ—¶: `file_datetime < current_hour`
3. ç¨³å®šæ€§æ£€æŸ¥: æ–‡ä»¶ä¿®æ”¹æ—¶é—´è·ç¦»ç°åœ¨è‡³å°‘300ç§’

#### æ‹‰å–æ¨¡å¼ï¼ˆc2_data_server.pyï¼‰

âœ… **å·²éªŒè¯** - ç¬¬173-178è¡Œ

```python
async def read_logs(self):
    """è¯»å–æ—¥å¿—æ–‡ä»¶ï¼ˆå®Œæ•´ç‰ˆï¼šæ”¯æŒæŒ‰å°æ—¶æ—¥å¿—ã€IPè§„èŒƒåŒ–ã€é¿å…é‡å¤è¯»å–ï¼‰"""
    # è·å–å¯ç”¨æ—¥å¿—æ–‡ä»¶ï¼ˆå¼‚æ­¥è°ƒç”¨ï¼‰
    # æ³¨æ„ï¼šåªè·å–ä¸Šä¸€å°æ—¶åŠæ›´æ—©çš„æ–‡ä»¶ï¼Œé¿å…è¯»å–æ­£åœ¨å†™å…¥çš„æ–‡ä»¶
    log_files = await self.log_reader.get_available_log_files(hours_back=48)
```

**éªŒè¯ç»“æœ**: âœ… æ‹‰å–æ¨¡å¼å¤ç”¨äº† `LogReader.get_available_log_files()`ï¼Œå®Œå…¨æ”¯æŒæŒ‰å°æ—¶æ—¥å¿—å’Œæ–‡ä»¶ç¨³å®šæ€§æ£€æŸ¥

---

### é—®é¢˜3: IPè§£æé—®é¢˜

**éœ€æ±‚**: å¤„ç†å¸¦å‰å¯¼é›¶çš„éæ ‡å‡†IPï¼ˆå¦‚ "01.10.238.162"ï¼‰

#### æ¨é€æ¨¡å¼ï¼ˆremote_uploader.pyï¼‰

âœ… **å·²ä¿®å¤** - ç¬¬855-896è¡Œ

```python
def normalize_ip(self, ip: str) -> Optional[str]:
    """è§„èŒƒåŒ–IPåœ°å€ï¼ˆå»é™¤å‰å¯¼é›¶ï¼‰å¹¶éªŒè¯"""
    try:
        parts = ip.split('.')
        if len(parts) != 4:
            return None
        
        # å°†æ¯ä¸ªéƒ¨åˆ†è½¬æ¢ä¸ºintå†è½¬å›strï¼Œè‡ªåŠ¨å»é™¤å‰å¯¼é›¶
        normalized_parts = []
        for part in parts:
            num = int(part)  # è¿™ä¼šè‡ªåŠ¨å¤„ç†å‰å¯¼é›¶
            if num < 0 or num > 255:
                return None
            normalized_parts.append(str(num))
        
        normalized_ip = '.'.join(normalized_parts)
        
        # è¿‡æ»¤ç§æœ‰IPå’Œç‰¹æ®ŠIP
        if normalized_ip.startswith(('127.', '10.', '192.168.', '169.254.')):
            return None
        if normalized_ip.startswith('172.'):
            second_octet = int(normalized_parts[1])
            if 16 <= second_octet <= 31:
                return None
        
        return normalized_ip
    except:
        return None

# åœ¨ extract_ip_and_timestamp_from_line ä¸­ä½¿ç”¨
def extract_ip_and_timestamp_from_line(self, line: str, file_path: Path = None):
    # ...
    for ip in ips:
        normalized_ip = self.normalize_ip(ip)  # è§„èŒƒåŒ–IP
        if normalized_ip:
            return {
                'ip': normalized_ip,  # ä½¿ç”¨è§„èŒƒåŒ–åçš„IP
                'raw_ip': ip if ip != normalized_ip else None,  # ä¿ç•™åŸå§‹IPç”¨äºè°ƒè¯•
                # ...
            }
```

**å¤„ç†ç¤ºä¾‹**:
- è¾“å…¥: `01.10.238.162`
- è¾“å‡º: `1.10.238.162` âœ…
- åŒæ—¶ä¿ç•™åŸå§‹IPåœ¨ `raw_ip` å­—æ®µä¸­

#### æ‹‰å–æ¨¡å¼ï¼ˆc2_data_server.pyï¼‰

âœ… **å·²éªŒè¯** - ç¬¬216-224è¡Œ

```python
# ä½¿ç”¨IPProcessorçš„å®Œæ•´è§£æé€»è¾‘ï¼ˆåŒ…å«IPè§„èŒƒåŒ–ï¼‰
ip_data = self.ip_processor.extract_ip_and_timestamp_from_line(
    line, 
    file_path=file_path
)

if ip_data:
    # ip_data å·²ç»åŒ…å«è§„èŒƒåŒ–åçš„IPå’Œå®Œæ•´æ—¶é—´æˆ³ä¿¡æ¯
    new_records.append(ip_data)
```

**éªŒè¯ç»“æœ**: âœ… æ‹‰å–æ¨¡å¼å®Œå…¨å¤ç”¨äº† `IPProcessor.normalize_ip()` æ–¹æ³•ï¼Œè‡ªåŠ¨å¤„ç†å¸¦å‰å¯¼é›¶çš„IP

---

## ğŸ”„ æ•°æ®æ ¼å¼å¯¹æ¯”

### æ¨é€æ¨¡å¼è¾“å‡º

```json
{
  "ip": "1.10.238.162",        // è§„èŒƒåŒ–åçš„IP
  "raw_ip": "01.10.238.162",   // åŸå§‹IPï¼ˆå¦‚æœä¸åŒï¼‰
  "timestamp": "2024-12-29T15:30:00",
  "timestamp_source": "parsed",
  "date": "2024-12-29",
  "log_hour": "2024-12-29_15",  // å°æ—¶ä¿¡æ¯
  "botnet_type": "ramnit"
}
```

### æ‹‰å–æ¨¡å¼è¾“å‡º

```json
{
  "ip": "1.10.238.162",        // è§„èŒƒåŒ–åçš„IP âœ…
  "raw_ip": "01.10.238.162",   // åŸå§‹IPï¼ˆå¦‚æœä¸åŒï¼‰ âœ…
  "timestamp": "2024-12-29T15:30:00",
  "timestamp_source": "parsed",
  "date": "2024-12-29",
  "log_hour": "2024-12-29_15",  // å°æ—¶ä¿¡æ¯ âœ…
  "botnet_type": "ramnit"
}
```

**ç»“è®º**: âœ… æ•°æ®æ ¼å¼å®Œå…¨ä¸€è‡´

---

## ğŸ“Š åŠŸèƒ½å¯¹æ¯”è¡¨

| åŠŸèƒ½ | æ¨é€æ¨¡å¼ | æ‹‰å–æ¨¡å¼ | ä¸€è‡´æ€§ |
|------|----------|----------|--------|
| **ä¸å»é‡ï¼Œä¼ è¾“æ‰€æœ‰æ•°æ®** | âœ… å·²å®ç° | âœ… å·²å®ç° | âœ… ä¸€è‡´ |
| **æŒ‰å°æ—¶ç”Ÿæˆæ—¥å¿—æ–‡ä»¶** | âœ… æ”¯æŒ `{datetime}` | âœ… å¤ç”¨ `LogReader` | âœ… ä¸€è‡´ |
| **åªå¤„ç†ä¸Šä¸€å°æ—¶çš„æ–‡ä»¶** | âœ… `< current_hour` | âœ… å¤ç”¨é€»è¾‘ | âœ… ä¸€è‡´ |
| **æ–‡ä»¶ç¨³å®šæ€§æ£€æŸ¥** | âœ… 300ç§’è¾¹ç•Œ | âœ… å¤ç”¨é€»è¾‘ | âœ… ä¸€è‡´ |
| **IPè§„èŒƒåŒ–ï¼ˆå»å‰å¯¼é›¶ï¼‰** | âœ… `normalize_ip()` | âœ… å¤ç”¨æ–¹æ³• | âœ… ä¸€è‡´ |
| **ä¿ç•™åŸå§‹IP** | âœ… `raw_ip` å­—æ®µ | âœ… å¤ç”¨é€»è¾‘ | âœ… ä¸€è‡´ |
| **æ—¶é—´æˆ³æå–** | âœ… å¤šç­–ç•¥ | âœ… å¤ç”¨é€»è¾‘ | âœ… ä¸€è‡´ |
| **å°æ—¶çº§æ—¶é—´æ ‡è®°** | âœ… `log_hour` | âœ… å¤ç”¨é€»è¾‘ | âœ… ä¸€è‡´ |

---

## âœ… æµ‹è¯•éªŒè¯

### æµ‹è¯•1: IPè§„èŒƒåŒ–

**è¾“å…¥æ—¥å¿—è¡Œ**:
```
2024-12-29 15:30:00,01.10.238.162
```

**æ¨é€æ¨¡å¼è¾“å‡º**:
```json
{"ip": "1.10.238.162", "raw_ip": "01.10.238.162"}
```

**æ‹‰å–æ¨¡å¼è¾“å‡º**:
```json
{"ip": "1.10.238.162", "raw_ip": "01.10.238.162"}
```

âœ… **ä¸€è‡´**

---

### æµ‹è¯•2: æŒ‰å°æ—¶æ–‡ä»¶è¿‡æ»¤

**å½“å‰æ—¶é—´**: 2024-12-29 16:30:00

**æ–‡ä»¶åˆ—è¡¨**:
```
ramnit_2024-12-29_14.log  â† âœ… åº”è¯¥å¤„ç†ï¼ˆä¸Š2å°æ—¶ï¼‰
ramnit_2024-12-29_15.log  â† âœ… åº”è¯¥å¤„ç†ï¼ˆä¸Š1å°æ—¶ï¼‰
ramnit_2024-12-29_16.log  â† âŒ ä¸å¤„ç†ï¼ˆå½“å‰å°æ—¶ï¼‰
```

**æ¨é€æ¨¡å¼**: âœ… åªå¤„ç†å‰ä¸¤ä¸ªæ–‡ä»¶  
**æ‹‰å–æ¨¡å¼**: âœ… åªå¤„ç†å‰ä¸¤ä¸ªæ–‡ä»¶

âœ… **ä¸€è‡´**

---

### æµ‹è¯•3: ä¸å»é‡éªŒè¯

**è¾“å…¥**:
```
2024-12-29 15:00:00,1.2.3.4
2024-12-29 15:01:00,1.2.3.4  â† ç›¸åŒIP
2024-12-29 15:02:00,1.2.3.4  â† ç›¸åŒIP
```

**æ¨é€æ¨¡å¼**: âœ… ä¼ è¾“3æ¡è®°å½•  
**æ‹‰å–æ¨¡å¼**: âœ… ä¼ è¾“3æ¡è®°å½•

âœ… **ä¸€è‡´**

---

## ğŸ”§ ä¼˜åŒ–ç»†èŠ‚

### æ‹‰å–æ¨¡å¼çš„é¢å¤–ä¼˜åŒ–

```python
# 1. é¿å…é‡å¤è¯»å–
self.processed_files = set()  # å·²å¤„ç†çš„æ–‡ä»¶åˆ—è¡¨

# 2. å¼‚æ­¥æ–‡ä»¶è¯»å–
async with aiofiles.open(file_path, 'r', encoding='utf-8', errors='ignore') as f:
    async for line in f:
        # å¤„ç†é€»è¾‘

# 3. å•æ¬¡è¯»å–é™åˆ¶
if len(new_records) >= 5000:
    logger.info(f"è¾¾åˆ°å•æ¬¡è¯»å–ä¸Šé™(5000æ¡)ï¼Œæš‚åœè¯»å–")
    break

# 4. å®šæœŸæ¸…ç†å·²å¤„ç†æ–‡ä»¶åˆ—è¡¨
if len(self.processed_files) > 100:
    # åªä¿ç•™æœ€è¿‘çš„50ä¸ª
    self.processed_files = self.processed_files & recent_file_keys
```

---

## ğŸ“ é…ç½®ç¤ºä¾‹

### æ¨é€æ¨¡å¼é…ç½®

```json
{
  "botnet": {
    "botnet_type": "ramnit",
    "log_dir": "/home/ubuntu/logs",
    "log_file_pattern": "ramnit_{datetime}.log"  // æŒ‰å°æ—¶
  }
}
```

### æ‹‰å–æ¨¡å¼é…ç½®

```python
# c2_data_server.py å¤ç”¨ç›¸åŒé…ç½®
from remote_uploader import CONFIG, LOG_DIR, LOG_FILE_PATTERN

# è‡ªåŠ¨ä½¿ç”¨ {datetime} æ¨¡å¼
```

---

## ğŸ‰ æ€»ç»“

### ä¸‰ä¸ªé—®é¢˜çš„å¤„ç†çŠ¶æ€

| é—®é¢˜ | æ¨é€æ¨¡å¼ | æ‹‰å–æ¨¡å¼ | éªŒè¯ç»“æœ |
|------|----------|----------|----------|
| **1. IPå»é‡** | âœ… ä¸å»é‡ | âœ… ä¸å»é‡ | âœ… ä¸€è‡´ |
| **2. æŒ‰å°æ—¶æ—¥å¿—** | âœ… æ”¯æŒ | âœ… æ”¯æŒ | âœ… ä¸€è‡´ |
| **3. IPè§„èŒƒåŒ–** | âœ… æ”¯æŒ | âœ… æ”¯æŒ | âœ… ä¸€è‡´ |

### æ ¸å¿ƒç»“è®º

1. âœ… **æ‹‰å–æ¨¡å¼å®Œå…¨å¤ç”¨äº†æ¨é€æ¨¡å¼çš„ä¿®å¤é€»è¾‘**
   - `c2_data_server.py` ç›´æ¥ä½¿ç”¨ `remote_uploader.py` çš„ `LogReader` å’Œ `IPProcessor`
   
2. âœ… **æ‰€æœ‰ä¸‰ä¸ªé—®é¢˜åœ¨æ‹‰å–æ¨¡å¼ä¸­éƒ½å·²æ­£ç¡®å¤„ç†**
   - IPä¸å»é‡ â†’ ä½¿ç”¨ç›¸åŒçš„ `process_line` é€»è¾‘
   - æŒ‰å°æ—¶æ—¥å¿— â†’ ä½¿ç”¨ç›¸åŒçš„ `get_available_log_files` é€»è¾‘
   - IPè§„èŒƒåŒ– â†’ ä½¿ç”¨ç›¸åŒçš„ `normalize_ip` æ–¹æ³•

3. âœ… **æ•°æ®æ ¼å¼å®Œå…¨ä¸€è‡´**
   - æ¨é€æ¨¡å¼å’Œæ‹‰å–æ¨¡å¼è¾“å‡ºçš„æ•°æ®ç»“æ„å®Œå…¨ç›¸åŒ
   - æœåŠ¡å™¨ç«¯æ—¥å¿—å¤„ç†å™¨å¯ä»¥æ— ç¼å¤„ç†ä¸¤ç§æ¨¡å¼çš„æ•°æ®

4. âœ… **æ‹‰å–æ¨¡å¼çš„é¢å¤–ä¼˜åŒ–**
   - é¿å…é‡å¤è¯»å–æ–‡ä»¶
   - å¼‚æ­¥æ–‡ä»¶I/O
   - å†…å­˜ä½¿ç”¨é™åˆ¶
   - å·²å¤„ç†æ–‡ä»¶åˆ—è¡¨ç®¡ç†

---

**éªŒè¯äººå‘˜**: Cascade  
**éªŒè¯æ—¶é—´**: 2024-12-29  
**éªŒè¯ç»“è®º**: âœ… æ‰€æœ‰é—®é¢˜éƒ½å·²åœ¨æ‹‰å–æ¨¡å¼ä¸­æ­£ç¡®å¤„ç†ï¼Œæ— éœ€é¢å¤–ä¿®æ”¹
