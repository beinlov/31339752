import re
import ipdb
import sys

nation_global = {
    '不丹',
    '东帝汶',
    '中国',
    '中非共和国',
    '丹麦',
    '乌克兰',
    '乌兹别克斯坦',
    '乌干达',
    '乌拉圭',
    '乍得',
    '也门',
    '亚美尼亚',
    '以色列',
    '伊拉克',
    '伊朗',
    '伯利兹',
    '佛得角',
    '俄罗斯',
    '保加利亚',
    '克罗地亚',
    '冈比亚',
    '冰岛',
    '几内亚',
    '几内亚比绍',
    '列支敦士登',
    '刚果共和国',
    '刚果民主共和国',
    '利比亚',
    '利比里亚',
    '加拿大',
    '加纳',
    '加蓬',
    '匈牙利',
    '北朝鲜',
    '南非',
    '博茨瓦纳',
    '卡塔尔',
    '卢旺达',
    '卢森堡',
    '印度',
    '印度尼西亚',
    '危地马拉',
    '厄瓜多尔',
    '厄立特里亚',
    '叙利亚',
    '古巴',
    '吉尔吉斯斯坦',
    '吉布提',
    '哈萨克斯坦',
    '哥伦比亚',
    '哥斯达黎加',
    '喀麦隆',
    '图瓦卢',
    '土库曼斯坦',
    '土耳其',
    '圣卢西亚',
    '圣基茨和尼维斯',
    '圣多美和普林西比',
    '圣文森特和格林纳丁斯',
    '圣马力诺',
    '圭亚那',
    '坦桑尼亚',
    '埃及',
    '埃塞俄比亚',
    '基里巴斯',
    '塔吉克斯坦',
    '塞内加尔',
    '塞尔维亚',
    '塞拉利昂',
    '塞浦路斯',
    '塞舌尔',
    '墨西哥',
    '多哥',
    '多米尼克',
    '多米尼加共和国',
    '奥地利',
    '委内瑞拉',
    '孟加拉国',
    '安哥拉',
    '安提瓜和巴布达',
    '安道尔',
    '密克罗尼西亚',
    '尼加拉瓜',
    '尼日利亚',
    '尼日尔',
    '尼泊尔',
    '巴哈马',
    '巴基斯坦',
    '巴巴多斯',
    '巴布亚新几内亚',
    '巴拉圭',
    '巴拿马',
    '巴林',
    '巴西',
    '布基纳法索',
    '布隆迪',
    '希腊',
    '帕劳',
    '德国',
    '意大利',
    '所罗门群岛',
    '拉脱维亚',
    '挪威',
    '捷克共和国',
    '摩尔多瓦',
    '摩洛哥',
    '摩纳哥',
    '文莱',
    '斐济',
    '斯洛伐克',
    '斯洛文尼亚',
    '斯里兰卡',
    '新加坡',
    '新西兰',
    '日本',
    '智利',
    '柬埔寨',
    '格林纳达',
    '格鲁吉亚',
    '梵蒂冈',
    '比利时',
    '毛里塔尼亚',
    '毛里求斯',
    '汤加',
    '沙特阿拉伯',
    '法国',
    '波兰',
    '波斯尼亚和黑塞哥维那',
    '泰国',
    '津巴布韦',
    '洪都拉斯',
    '海地',
    '澳大利亚',
    '爱尔兰',
    '爱沙尼亚',
    '牙买加',
    '特立尼达和多巴哥',
    '玻利维亚',
    '瑙鲁',
    '瑞典',
    '瑞士',
    '瓦努阿图',
    '白俄罗斯',
    '科威特',
    '科摩罗',
    '科特迪瓦',
    '秘鲁',
    '突尼斯',
    '立陶宛',
    '索马里',
    '约旦',
    '纳米比亚',
    '缅甸',
    '罗马尼亚',
    '美国',
    '老挝',
    '肯尼亚',
    '芬兰',
    '苏丹',
    '苏里南',
    '英国',
    '荷兰',
    '莫桑比克',
    '莱索托',
    '菲律宾',
    '萨尔瓦多',
    '萨摩亚',
    '葡萄牙',
    '蒙古',
    '西班牙',
    '贝宁',
    '赞比亚',
    '赤道几内亚',
    '越南',
    '阿塞拜疆',
    '阿富汗',
    '阿尔及利亚',
    '阿尔巴尼亚',
    '阿拉伯联合酋长国',
    '阿曼',
    '阿根廷',
    '韩国',
    '马其顿',
    '马尔代夫',
    '马拉维',
    '马来西亚',
    '马绍尔群岛',
    '马耳他',
    '马达加斯加',
    '马里',
    '黎巴嫩',
    '黑山',
}

# 引入 IP 数据库（ipdb）并初始化查询缓存
db = ipdb.District("./qqwry.ipdb")  # 创建一个 `District` 对象，加载 IP 库文件 "qqwry.ipdb"
query_cached = {}  # 用于缓存 IP 查询结果的字典，避免重复查询


# 判断是否是中国大陆的 IP 地址
def is_ip_chinamainland(ip):
    nation, province = get_address(ip)  # 获取该 IP 地址对应的国家和省区信息
    if nation == '中国':  # 如果国家为中国
        # 如果省份不是香港、澳门或台湾，返回 True（表示该 IP 地址是中国大陆的）
        if province[:2] not in ['香港', '澳门', '台湾']:
            return True
    return False  # 不是中国大陆 IP 或省份为香港、澳门或台湾时，返回 False


# 根据国家名猜测国家的名称
def guess_nation(nation):
    n = len(nation)  # 获取国家名称的长度
    while n > 2:  # 循环逐步缩短国家名称，直到匹配为止
        n -= 1
        if nation[:n] in nation_global:  # 如果缩短后的名称在全球国家列表中，则返回该名称
            return nation[:n]
    return nation  # 如果没有匹配的名称，则返回原国家名


# 获取 IP 地址对应的国家和省区信息
def get_address(ip: str):
    # 检查缓存中是否已经存有该 IP 的查询结果
    q = query_cached.get(ip)
    if q is not None:  # 如果缓存中有数据，直接返回
        return q

    nation = province = ''  # 初始化国家和省区为空字符串
    try:
        # 查询 IP 地址的国家和省区信息，'CN' 表示中国
        ll = db.find(ip, 'CN')
        nation = ll[0]  # 获取国家
        province = ll[1]  # 获取省区
        if nation not in nation_global:  # 如果国家不在全球国家列表中，尝试猜测正确的国家名称
            nation = guess_nation(nation)
    except:
        pass  # 如果查询失败，什么也不做

    query_cached[ip] = (nation, province)  # 将查询结果缓存
    return (nation, province)  # 返回国家和省区


# 验证是否是有效的 IP 地址
def is_ip(ipAddr):
    # 使用正则表达式检查 IP 地址的格式是否合法
    check_ip = re.compile(
        '^(1\d{2}|2[0-4]\d|25[0-5]|[1-9]\d|[1-9])\.(1\d{2}|2[0-4]\d|25[0-5]|[1-9]\d|\d)\.(1\d{2}|2[0-4]\d|25[0-5]|[1-9]\d|\d)\.(1\d{2}|2[0-4]\d|25[0-5]|[1-9]\d|\d)$')
    if check_ip.match(ipAddr):  # 如果 IP 地址格式匹配正则表达式
        return True  # 返回 True，表示该 IP 地址格式合法
    else:
        return False  # 否则返回 False，表示该 IP 地址格式不合法


# 如果是直接执行脚本（非导入方式），则执行以下代码
if __name__ == '__main__':
    ips = sys.argv[1:]  # 获取命令行参数中的 IP 地址（脚本运行时传递的参数）
    for i in ips:
        print(get_address(i))  # 打印每个 IP 地址的国家和省区信息

# 这个代码实现了一个IP地址解析工具，主要用于查询IP地址的地理位置信息（国家和省份），并支持判断IP地址是否属于中国大陆。其核心功能包括：
# 加载IP地址数据库并查询地理位置。
# 判断IP地址是否属于中国大陆。
# 验证IP地址的格式是否正确。
# 缓存查询结果以提高性能。
