# æ•°æ®å»é‡æœºåˆ¶è¯´æ˜

## ğŸ“‹ æ¦‚è¿°

ç³»ç»Ÿå®ç°äº†**åŒå±‚å»é‡æœºåˆ¶**ï¼Œç¡®ä¿ä¸ä¼šæ’å…¥é‡å¤çš„èŠ‚ç‚¹æ•°æ®ï¼š

1. **åº”ç”¨å±‚å»é‡** - åœ¨å†™å…¥æ•°æ®åº“ä¹‹å‰æ£€æŸ¥
2. **æ•°æ®åº“å±‚å»é‡** - ä½¿ç”¨å”¯ä¸€çº¦æŸé˜²æ­¢é‡å¤æ’å…¥

## ğŸ”§ å®ç°ç»†èŠ‚

### 1. åº”ç”¨å±‚å»é‡

**ä½ç½®**: `backend/log_processor/db_writer.py`

**æœºåˆ¶**:
```python
# ä¸ºæ¯æ¡è®°å½•ç”Ÿæˆå”¯ä¸€æ ‡è¯†
record_key = f"{ip}|{timestamp}|{event_type}"

# æ£€æŸ¥æ˜¯å¦å·²å¤„ç†
if record_key in self.processed_records:
    self.duplicate_count += 1
    return  # è·³è¿‡é‡å¤è®°å½•

# è®°å½•å·²å¤„ç†
self.processed_records.add(record_key)
```

**ä¼˜ç‚¹**:
- âœ… å¿«é€Ÿæ£€æŸ¥ï¼ˆå†…å­˜æŸ¥æ‰¾ï¼‰
- âœ… é¿å…ä¸å¿…è¦çš„æ•°æ®åº“æ“ä½œ
- âœ… å®æ—¶ç»Ÿè®¡é‡å¤æ•°é‡

**é™åˆ¶**:
- âš ï¸ ä»…åœ¨å½“å‰è¿è¡ŒæœŸé—´æœ‰æ•ˆ
- âš ï¸ é‡å¯åç¼“å­˜æ¸…ç©º

### 2. æ•°æ®åº“å±‚å»é‡

**æœºåˆ¶**: åœ¨è¡¨ä¸Šæ·»åŠ å”¯ä¸€çº¦æŸ

```sql
UNIQUE KEY idx_unique_record (ip, created_at)
```

**å†™å…¥æ–¹å¼**:
```sql
INSERT IGNORE INTO botnet_nodes_xxx (...) VALUES (...)
```

**ä¼˜ç‚¹**:
- âœ… æ°¸ä¹…æœ‰æ•ˆï¼ˆå³ä½¿é‡å¯ï¼‰
- âœ… æ•°æ®åº“çº§åˆ«ä¿è¯
- âœ… è‡ªåŠ¨è·³è¿‡é‡å¤è®°å½•

## ğŸ“Š å»é‡ç­–ç•¥

### åˆ¤æ–­é‡å¤çš„ä¾æ®

ä¸¤æ¡è®°å½•è¢«è®¤ä¸ºæ˜¯é‡å¤çš„ï¼Œå½“ä¸”ä»…å½“ï¼š
- **IPåœ°å€ç›¸åŒ** AND
- **åˆ›å»ºæ—¶é—´ç›¸åŒ**ï¼ˆç²¾ç¡®åˆ°ç§’ï¼‰

**ç¤ºä¾‹**:
```
è®°å½•1: 192.168.1.1, 2025-10-30 10:00:00, infection
è®°å½•2: 192.168.1.1, 2025-10-30 10:00:00, beacon
```
â†’ **ä¸é‡å¤**ï¼ˆevent_typeä¸åŒï¼Œä½†æ—¶é—´æˆ³ç›¸åŒä¼šè¢«è§†ä¸ºé‡å¤ï¼‰

```
è®°å½•1: 192.168.1.1, 2025-10-30 10:00:00, infection
è®°å½•2: 192.168.1.1, 2025-10-30 10:00:00, infection
```
â†’ **é‡å¤**ï¼ˆIPå’Œæ—¶é—´éƒ½ç›¸åŒï¼‰

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### æ–°ç³»ç»Ÿï¼ˆæ¨èï¼‰

æ–°åˆ›å»ºçš„è¡¨ä¼šè‡ªåŠ¨åŒ…å«å”¯ä¸€çº¦æŸï¼Œæ— éœ€é¢å¤–æ“ä½œã€‚

### ç°æœ‰ç³»ç»Ÿè¿ç§»

#### æ­¥éª¤1: å¤‡ä»½æ•°æ®åº“
```bash
mysqldump -u root -p botnet > botnet_backup_$(date +%Y%m%d).sql
```

#### æ­¥éª¤2: æ¸…ç†ç°æœ‰é‡å¤æ•°æ®
```bash
mysql -u root -p botnet < log_processor/clean_duplicates.sql
```

è¿™ä¼šåˆ é™¤é‡å¤è®°å½•ï¼Œåªä¿ç•™æœ€æ—©çš„ä¸€æ¡ã€‚

#### æ­¥éª¤3: æ·»åŠ å”¯ä¸€çº¦æŸ
```bash
mysql -u root -p botnet < log_processor/add_unique_constraint.sql
```

#### æ­¥éª¤4: éªŒè¯
```sql
-- æ£€æŸ¥çº¦æŸæ˜¯å¦æ·»åŠ æˆåŠŸ
SHOW INDEX FROM botnet_nodes_asruex WHERE Key_name = 'idx_unique_record';

-- å°è¯•æ’å…¥é‡å¤æ•°æ®ï¼ˆåº”è¯¥è¢«å¿½ç•¥ï¼‰
INSERT IGNORE INTO botnet_nodes_asruex (ip, created_at, ...) 
VALUES ('1.1.1.1', NOW(), ...);
```

## ğŸ“ˆ ç›‘æ§å»é‡æ•ˆæœ

### æŸ¥çœ‹å®æ—¶ç»Ÿè®¡

æ—¥å¿—å¤„ç†å™¨æ¯60ç§’è¾“å‡ºç»Ÿè®¡ä¿¡æ¯ï¼š

```
[asruex] Written: 1000, Duplicates: 50 (4.76%), Buffer: 0
[mozi] Written: 800, Duplicates: 120 (13.04%), Buffer: 0
```

### æŸ¥è¯¢æ•°æ®åº“

```sql
-- æ£€æŸ¥æ˜¯å¦è¿˜æœ‰é‡å¤æ•°æ®
SELECT ip, created_at, COUNT(*) as count
FROM botnet_nodes_asruex
GROUP BY ip, created_at
HAVING count > 1;

-- åº”è¯¥è¿”å›0è¡Œ
```

## ğŸ” å¸¸è§åœºæ™¯å¤„ç†

### åœºæ™¯1: æ—¥å¿—æ–‡ä»¶é‡æ–°ä¸Šä¼ 

**æƒ…å†µ**: è¿œç«¯é‡æ–°ç”Ÿæˆå¹¶ä¸Šä¼ äº†åŒ…å«å†å²æ•°æ®çš„æ—¥å¿—æ–‡ä»¶

**å¤„ç†**:
1. **åº”ç”¨å±‚**: å¦‚æœåœ¨åŒä¸€è¿è¡ŒæœŸé—´ï¼Œä¼šè¢«å†…å­˜ç¼“å­˜æ‹¦æˆª
2. **æ•°æ®åº“å±‚**: å¦‚æœè·¨è¿è¡ŒæœŸé—´ï¼Œä¼šè¢«å”¯ä¸€çº¦æŸæ‹¦æˆª

**ç»“æœ**: âœ… ä¸ä¼šæ’å…¥é‡å¤æ•°æ®

### åœºæ™¯2: æ—¥å¿—æ–‡ä»¶å†…éƒ¨æœ‰é‡å¤è¡Œ

**æƒ…å†µ**: åŒä¸€ä¸ªæ—¥å¿—æ–‡ä»¶ä¸­æœ‰é‡å¤çš„è¡Œ

```
2025-10-30 10:00:00,1.1.1.1,infection
2025-10-30 10:00:00,1.1.1.1,infection  â† é‡å¤
```

**å¤„ç†**:
1. **åº”ç”¨å±‚**: ç¬¬ä¸€å±‚æ‹¦æˆªï¼Œç¬¬äºŒè¡Œè¢«è·³è¿‡
2. **ç»Ÿè®¡**: `duplicate_count` å¢åŠ 

**ç»“æœ**: âœ… ä¸ä¼šæ’å…¥é‡å¤æ•°æ®

### åœºæ™¯3: å¤šä¸ªæ—¥å¿—æ–‡ä»¶åŒ…å«ç›¸åŒæ•°æ®

**æƒ…å†µ**: ä¸åŒçš„æ—¥å¿—æ–‡ä»¶åŒ…å«ç›¸åŒçš„è®°å½•

```
# logs/mozi/2025-10-30.txt
2025-10-30 10:00:00,1.1.1.1,infection

# logs/mozi/2025-10-30-backup.txt
2025-10-30 10:00:00,1.1.1.1,infection  â† é‡å¤
```

**å¤„ç†**:
1. **åº”ç”¨å±‚**: å¦‚æœåœ¨åŒä¸€è¿è¡ŒæœŸé—´å¤„ç†ï¼Œä¼šè¢«æ‹¦æˆª
2. **æ•°æ®åº“å±‚**: å¦‚æœåˆ†åˆ«å¤„ç†ï¼Œä¼šè¢«å”¯ä¸€çº¦æŸæ‹¦æˆª

**ç»“æœ**: âœ… ä¸ä¼šæ’å…¥é‡å¤æ•°æ®

### åœºæ™¯4: ç³»ç»Ÿé‡å¯åé‡æ–°å¤„ç†

**æƒ…å†µ**: ç³»ç»Ÿé‡å¯ï¼Œåº”ç”¨å±‚ç¼“å­˜æ¸…ç©º

**å¤„ç†**:
1. **åº”ç”¨å±‚**: ç¼“å­˜å·²æ¸…ç©ºï¼Œæ— æ³•æ‹¦æˆª
2. **æ•°æ®åº“å±‚**: å”¯ä¸€çº¦æŸæ‹¦æˆª

**ç»“æœ**: âœ… ä¸ä¼šæ’å…¥é‡å¤æ•°æ®ï¼ˆæ•°æ®åº“å±‚ä¿æŠ¤ï¼‰

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. æ—¶é—´ç²¾åº¦

å”¯ä¸€çº¦æŸåŸºäº `created_at` å­—æ®µï¼Œç²¾ç¡®åˆ°**ç§’**ã€‚

å¦‚æœåŒä¸€IPåœ¨åŒä¸€ç§’å†…æœ‰å¤šä¸ªä¸åŒäº‹ä»¶ï¼Œåªä¼šä¿ç•™ç¬¬ä¸€ä¸ªã€‚

**ç¤ºä¾‹**:
```
2025-10-30 10:00:00.123,1.1.1.1,infection  â† ä¿ç•™
2025-10-30 10:00:00.456,1.1.1.1,beacon     â† è¢«è§†ä¸ºé‡å¤ï¼ˆç§’ç›¸åŒï¼‰
```

**è§£å†³æ–¹æ¡ˆ**ï¼ˆå¦‚éœ€è¦ï¼‰:
```sql
-- ä¿®æ”¹å”¯ä¸€çº¦æŸï¼Œå¢åŠ  event_type
ALTER TABLE botnet_nodes_asruex 
DROP INDEX idx_unique_record,
ADD UNIQUE KEY idx_unique_record (ip, created_at, event_type);
```

### 2. å†…å­˜å ç”¨

åº”ç”¨å±‚ç¼“å­˜ `processed_records` ä¼šéšç€å¤„ç†çš„è®°å½•å¢åŠ è€Œå¢é•¿ã€‚

**ä¼°ç®—**:
- æ¯æ¡è®°å½•çº¦ 100 å­—èŠ‚
- 100ä¸‡æ¡è®°å½•çº¦ 100MB

**ä¼˜åŒ–**ï¼ˆå¦‚éœ€è¦ï¼‰:
```python
# å®šæœŸæ¸…ç†ç¼“å­˜ï¼ˆå¦‚æ¯å°æ—¶ï¼‰
if len(self.processed_records) > 1000000:
    self.processed_records.clear()
```

### 3. æ€§èƒ½å½±å“

**åº”ç”¨å±‚å»é‡**: å‡ ä¹æ— å½±å“ï¼ˆå†…å­˜æŸ¥æ‰¾ï¼‰

**æ•°æ®åº“å±‚å»é‡**: 
- å”¯ä¸€ç´¢å¼•ä¼šç•¥å¾®é™ä½æ’å…¥é€Ÿåº¦ï¼ˆçº¦5-10%ï¼‰
- ä½†é¿å…äº†é‡å¤æ•°æ®ï¼Œæ•´ä½“æ”¶ç›Šå¤§äºæˆæœ¬

## ğŸ“Š ç»Ÿè®¡ä¿¡æ¯

### å»é‡ç‡è®¡ç®—

```
å»é‡ç‡ = é‡å¤è®°å½•æ•° / (æˆåŠŸå†™å…¥æ•° + é‡å¤è®°å½•æ•°) Ã— 100%
```

**æ­£å¸¸èŒƒå›´**:
- 0-5%: æ­£å¸¸ï¼ˆå¶å°”çš„é‡å¤ï¼‰
- 5-20%: éœ€è¦å…³æ³¨ï¼ˆå¯èƒ½æœ‰æ—¥å¿—é‡ä¼ ï¼‰
- >20%: å¼‚å¸¸ï¼ˆæ£€æŸ¥æ—¥å¿—ä¼ è¾“é…ç½®ï¼‰

### æŸ¥çœ‹ç»Ÿè®¡

```bash
# å®æ—¶æŸ¥çœ‹
tail -f log_processor.log | grep "Duplicates"

# è¾“å‡ºç¤ºä¾‹
[asruex] Written: 1000, Duplicates: 50 (4.76%), Buffer: 0
```

## ğŸ”§ æ•…éšœæ’æŸ¥

### é—®é¢˜1: æ·»åŠ å”¯ä¸€çº¦æŸå¤±è´¥

**é”™è¯¯**: `Duplicate entry '1.1.1.1-2025-10-30 10:00:00' for key 'idx_unique_record'`

**åŸå› **: è¡¨ä¸­å·²æœ‰é‡å¤æ•°æ®

**è§£å†³**:
```bash
# å…ˆæ¸…ç†é‡å¤æ•°æ®
mysql -u root -p botnet < log_processor/clean_duplicates.sql

# å†æ·»åŠ çº¦æŸ
mysql -u root -p botnet < log_processor/add_unique_constraint.sql
```

### é—®é¢˜2: å»é‡ç‡å¼‚å¸¸é«˜

**ç—‡çŠ¶**: å»é‡ç‡ > 20%

**æ£€æŸ¥**:
1. æ˜¯å¦æœ‰å¤šä¸ªè¿›ç¨‹åŒæ—¶å¤„ç†ç›¸åŒçš„æ—¥å¿—ï¼Ÿ
2. æ—¥å¿—æ–‡ä»¶æ˜¯å¦è¢«é‡å¤ä¸Šä¼ ï¼Ÿ
3. è¿œç«¯æ˜¯å¦é‡æ–°ç”Ÿæˆäº†å†å²æ—¥å¿—ï¼Ÿ

**è§£å†³**:
- æ£€æŸ¥æ—¥å¿—ä¼ è¾“é…ç½®
- ä½¿ç”¨ `rsync --append` åªä¼ è¾“å¢é‡
- é¿å…é‡å¤ä¸Šä¼ æ•´ä¸ªæ—¥å¿—æ–‡ä»¶

### é—®é¢˜3: å†…å­˜å ç”¨è¿‡é«˜

**ç—‡çŠ¶**: å¤„ç†å™¨å†…å­˜å ç”¨æŒç»­å¢é•¿

**åŸå› **: `processed_records` ç¼“å­˜è¿‡å¤§

**è§£å†³**:
```python
# åœ¨ db_writer.py çš„ flush() æ–¹æ³•ä¸­æ·»åŠ 
if len(self.processed_records) > 1000000:
    logger.info(f"[{self.botnet_type}] Clearing processed_records cache")
    self.processed_records.clear()
```

## ğŸ“š ç›¸å…³æ–‡ä»¶

- `db_writer.py` - å»é‡å®ç°ä»£ç 
- `clean_duplicates.sql` - æ¸…ç†ç°æœ‰é‡å¤æ•°æ®
- `add_unique_constraint.sql` - æ·»åŠ å”¯ä¸€çº¦æŸ
- `main.py` - ç»Ÿè®¡ä¿¡æ¯è¾“å‡º

## âœ… éªŒè¯æ¸…å•

éƒ¨ç½²åéªŒè¯ï¼š

- [ ] æ•°æ®åº“å”¯ä¸€çº¦æŸå·²æ·»åŠ 
- [ ] å°è¯•æ’å…¥é‡å¤æ•°æ®è¢«æ‹’ç»
- [ ] æ—¥å¿—æ˜¾ç¤ºå»é‡ç»Ÿè®¡ä¿¡æ¯
- [ ] å»é‡ç‡åœ¨åˆç†èŒƒå›´å†…ï¼ˆ<20%ï¼‰
- [ ] æ•°æ®åº“ä¸­æ— é‡å¤è®°å½•

---

**å®æ–½å®Œæˆï¼** ç³»ç»Ÿç°åœ¨å…·æœ‰å®Œå–„çš„å»é‡æœºåˆ¶ï¼Œå¯ä»¥å®‰å…¨å¤„ç†é‡å¤æ•°æ®ã€‚





